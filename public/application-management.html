<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gestion des Applications - FHIRHub</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/css/styles.css">
  <style>
    /* Styles spécifiques à la page de gestion des applications */
    .apps-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    .app-cards {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(460px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    .app-card {
      background-color: white;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      overflow: hidden;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .app-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
    }
    .app-header {
      background: linear-gradient(135deg, #e74c3c, #ff9966);
      padding: 20px;
      color: white;
      position: relative;
    }
    .app-title {
      font-size: 20px;
      font-weight: 700;
      margin-right: 100px;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    }
    .app-description {
      margin-top: 5px;
      font-size: 14px;
      opacity: 0.9;
    }
    .app-actions {
      position: absolute;
      top: 20px;
      right: 20px;
      display: flex;
      gap: 10px;
    }
    .app-body {
      padding: 20px;
    }
    .app-tabs {
      display: flex;
      border-bottom: 1px solid #eee;
      margin-bottom: 15px;
    }
    .app-tab {
      padding: 10px 15px;
      cursor: pointer;
      font-weight: 500;
      color: #777;
      position: relative;
      transition: color 0.2s;
    }
    .app-tab.active {
      color: #e74c3c;
    }
    .app-tab.active::after {
      content: '';
      position: absolute;
      bottom: -1px;
      left: 0;
      width: 100%;
      height: 3px;
      background: linear-gradient(135deg, #e74c3c, #ff9966);
      border-radius: 3px 3px 0 0;
    }
    .app-tab-content {
      display: none;
    }
    .app-tab-content.active {
      display: block;
    }
    .app-info {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
      margin-bottom: 20px;
    }
    .app-info-item {
      background-color: #f8f9fa;
      padding: 15px;
      border-radius: 8px;
    }
    .app-info-label {
      font-size: 12px;
      color: #777;
      margin-bottom: 5px;
    }
    .app-info-value {
      font-weight: 500;
      color: #333;
    }
    .api-keys-list {
      background-color: #f8f9fa;
      border-radius: 8px;
      padding: 15px;
      max-height: 250px;
      overflow-y: auto;
    }
    .key-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px;
      border-bottom: 1px solid #eee;
      background-color: white;
      border-radius: 5px;
      margin-bottom: 10px;
    }
    .key-item:last-child {
      margin-bottom: 0;
    }
    .key-info {
      flex: 1;
    }
    .key-primary {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 5px;
    }
    .key-value {
      font-family: monospace;
      background-color: #f0f0f0;
      padding: 5px 10px;
      border-radius: 4px;
      font-size: 14px;
      position: relative;
    }
    .key-masked {
      letter-spacing: 2px;
    }
    .key-secondary {
      font-size: 13px;
      color: #777;
    }
    .key-actions {
      display: flex;
      gap: 5px;
    }
    .status-badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 500;
    }
    .status-active {
      background-color: #e3f8e4;
      color: #27ae60;
    }
    .status-revoked {
      background-color: #fbe8e5;
      color: #e74c3c;
    }
    .status-expired {
      background-color: #f9f3eb;
      color: #f39c12;
    }
    .btn {
      border: none;
      padding: 8px 16px;
      border-radius: 5px;
      font-weight: 500;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      gap: 8px;
    }
    .btn-primary {
      background: linear-gradient(135deg, #e74c3c, #ff9966);
      color: white;
    }
    .btn-primary:hover {
      background: linear-gradient(135deg, #c0392b, #e67e22);
      box-shadow: 0 4px 8px rgba(231, 76, 60, 0.2);
    }
    .btn-secondary {
      background-color: #f1f1f1;
      color: #333;
    }
    .btn-secondary:hover {
      background-color: #ddd;
    }
    .btn-danger {
      background-color: #e74c3c;
      color: white;
    }
    .btn-danger:hover {
      background-color: #c0392b;
    }
    .btn-sm {
      padding: 5px 10px;
      font-size: 13px;
    }
    .btn-icon {
      width: 36px;
      height: 36px;
      padding: 0;
      border-radius: 50%;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      background-color: rgba(255, 255, 255, 0.2);
      color: white;
      border: none;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    .btn-icon:hover {
      background-color: rgba(255, 255, 255, 0.3);
    }
    .btn-group {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    .modal-content {
      background-color: white;
      border-radius: 10px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      width: 500px;
      max-width: 90%;
      overflow: hidden;
    }
    .modal-header {
      background: linear-gradient(135deg, #e74c3c, #ff9966);
      padding: 20px;
      color: white;
    }
    .modal-title {
      font-size: 20px;
      font-weight: 500;
      margin: 0;
    }
    .modal-body {
      padding: 20px;
    }
    .modal-footer {
      padding: 15px 20px;
      border-top: 1px solid #eee;
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }
    .form-group {
      margin-bottom: 20px;
    }
    .form-label {
      display: block;
      font-weight: 500;
      margin-bottom: 8px;
      color: #333;
    }
    .form-input {
      width: 100%;
      padding: 10px 15px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-family: inherit;
      font-size: 14px;
      transition: border-color 0.2s;
    }
    .form-input:focus {
      border-color: #e74c3c;
      outline: none;
    }
    .form-textarea {
      width: 100%;
      padding: 10px 15px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-family: inherit;
      font-size: 14px;
      min-height: 100px;
      resize: vertical;
      transition: border-color 0.2s;
    }
    .form-textarea:focus {
      border-color: #e74c3c;
      outline: none;
    }
    .form-select {
      width: 100%;
      padding: 10px 15px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-family: inherit;
      font-size: 14px;
      background-color: white;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%23333' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 10px center;
      background-size: 16px;
      transition: border-color 0.2s;
    }
    .form-select:focus {
      border-color: #e74c3c;
      outline: none;
    }
    .no-apps {
      text-align: center;
      padding: 60px 0;
      background-color: #f8f9fa;
      border-radius: 10px;
      margin-top: 20px;
    }
    .no-apps i {
      font-size: 60px;
      color: #ddd;
      margin-bottom: 20px;
    }
    .no-apps h2 {
      font-size: 24px;
      color: #555;
      margin-bottom: 10px;
    }
    .no-apps p {
      color: #777;
      max-width: 400px;
      margin: 0 auto;
    }
    .new-key-alert {
      background-color: #e3f8e4;
      border-radius: 8px;
      padding: 20px;
      margin-top: 20px;
      position: relative;
      display: none;
    }
    .new-key-alert h3 {
      color: #27ae60;
      margin-top: 0;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .new-key-value {
      background-color: #f8f8f8;
      padding: 15px;
      border-radius: 5px;
      font-family: monospace;
      margin: 15px 0;
      word-break: break-all;
      position: relative;
      font-weight: 500;
      color: #2c3e50;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .api-usage {
      margin-top: 20px;
    }
    .usage-chart {
      height: 200px;
      background-color: #f8f9fa;
      border-radius: 8px;
      padding: 20px;
      margin-top: 10px;
    }
    .usage-stats {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 15px;
      margin-top: 15px;
    }
    .usage-stat {
      background-color: #f8f9fa;
      padding: 15px;
      border-radius: 8px;
      text-align: center;
    }
    .usage-value {
      font-size: 24px;
      font-weight: 700;
      color: #e74c3c;
      margin-bottom: 5px;
    }
    .usage-label {
      font-size: 13px;
      color: #777;
    }
    .copy-btn {
      background: none;
      border: none;
      color: #3498db;
      cursor: pointer;
      padding: 5px;
      transition: color 0.2s;
    }
    .copy-btn:hover {
      color: #2980b9;
    }
    .date-picker {
      width: 100%;
      padding: 10px 15px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-family: inherit;
      font-size: 14px;
      transition: border-color 0.2s;
    }
    .date-picker:focus {
      border-color: #e74c3c;
      outline: none;
    }
    .active-toggle {
      display: flex;
      align-items: center;
      margin-top: 15px;
    }
    .toggle-switch {
      position: relative;
      display: inline-block;
      width: 50px;
      height: 24px;
      margin-right: 10px;
    }
    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: .4s;
      border-radius: 34px;
    }
    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 16px;
      width: 16px;
      left: 4px;
      bottom: 4px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }
    input:checked + .toggle-slider {
      background: linear-gradient(135deg, #e74c3c, #ff9966);
    }
    input:checked + .toggle-slider:before {
      transform: translateX(26px);
    }
    .toggle-label {
      font-weight: 500;
      color: #333;
    }
  </style>
</head>
<body>
  <header class="header">
    <div class="container">
      <div class="logo">
        <img src="/img/flame-icon-white.svg" alt="FHIRHub Logo">
        <span>FHIRHub</span>
      </div>
      
      <ul class="nav-menu">
        <li><a href="/dashboard.html"><i class="fas fa-chart-line"></i> Tableau de bord</a></li>
        <li><a href="/convert.html"><i class="fas fa-exchange-alt"></i> Conversion</a></li>
        <li><a href="/application-management.html" class="active"><i class="fas fa-th"></i> Applications</a></li>
        <li><a href="/workflows.html"><i class="fas fa-project-diagram"></i> Workflows</a></li>
        <li><a href="/users.html"><i class="fas fa-users"></i> Utilisateurs</a></li>
        <li><a href="/terminologies.html"><i class="fas fa-book-medical"></i> Terminologies</a></li>
        <li><a href="/ai-settings.html"><i class="fas fa-robot"></i> Paramètres IA</a></li>
        <li><a href="/documentation.html"><i class="fas fa-file-alt"></i> Documentation</a></li>
        <li><a href="/api-docs/"><i class="fas fa-code"></i> API</a></li>
        <li><a href="#" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Déconnexion</a></li>
      </ul>
    </div>
  </header>

  <div class="main-content">
    <div class="container">
      <div class="apps-header">
        <h1>Gestion des Applications</h1>
        <button class="btn btn-primary" id="addAppBtn"><i class="fas fa-plus"></i> Nouvelle application</button>
      </div>
      
      <div id="applicationsList" class="app-cards">
        <!-- Applications will be loaded here -->
      </div>
      
      <!-- Message "Aucune application" qui s'affiche lorsqu'il n'y a pas d'applications -->
      <div class="no-apps" id="noAppsMessage" style="display: none;">
        <i class="fas fa-laptop-code"></i>
        <h2>Aucune application</h2>
        <p>Vous n'avez pas encore créé d'applications. Cliquez sur "Nouvelle application" pour commencer.</p>
      </div>
    </div>
  </div>
  
  <!-- Modal pour ajouter/modifier une application -->
  <div id="appModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title" id="modalTitle">Nouvelle application</h2>
      </div>
      
      <div class="modal-body">
        <form id="appForm">
          <input type="hidden" id="appId">
          
          <div class="form-group">
            <label for="appName" class="form-label">Nom de l'application *</label>
            <input type="text" id="appName" class="form-input" required>
          </div>
          
          <div class="form-group">
            <label for="appDescription" class="form-label">Description</label>
            <textarea id="appDescription" class="form-textarea" placeholder="Description de l'application et de son utilisation..."></textarea>
          </div>
          
          <div class="form-group">
            <label for="appCorsOrigins" class="form-label">Origines CORS autorisées</label>
            <input type="text" id="appCorsOrigins" class="form-input" placeholder="http://example.com, https://app.example.com">
            <small>Séparez les différentes origines par des virgules</small>
          </div>
          
          <div class="form-group">
            <label for="appMaxConversions" class="form-label">Limite de conversions par jour</label>
            <input type="number" id="appMaxConversions" class="form-input" value="1000" min="1">
          </div>
          
          <div class="form-group">
            <label for="appMaxMessageSize" class="form-label">Taille maximale des messages (octets)</label>
            <input type="number" id="appMaxMessageSize" class="form-input" value="100000" min="1000">
          </div>
        </form>
      </div>
      
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" id="cancelAppBtn">Annuler</button>
        <button type="button" class="btn btn-primary" id="saveAppBtn">Enregistrer</button>
      </div>
    </div>
  </div>
  
  <!-- Modal pour ajouter une clé API -->
  <div id="keyModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">Nouvelle clé API</h2>
      </div>
      
      <div class="modal-body">
        <form id="keyForm">
          <input type="hidden" id="keyAppId">
          
          <div class="form-group">
            <label for="keyDescription" class="form-label">Description</label>
            <input type="text" id="keyDescription" class="form-input" placeholder="ex: Clé de production, Clé de développement...">
          </div>
          
          <div class="form-group">
            <label for="keyExpires" class="form-label">Date d'expiration</label>
            <input type="date" id="keyExpires" class="date-picker">
            <small>Laissez vide pour une clé sans date d'expiration</small>
          </div>
          
          <div class="active-toggle">
            <label class="toggle-switch">
              <input type="checkbox" id="keyActive" checked>
              <span class="toggle-slider"></span>
            </label>
            <span class="toggle-label">Clé active</span>
          </div>
        </form>
      </div>
      
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" id="cancelKeyBtn">Annuler</button>
        <button type="button" class="btn btn-primary" id="saveKeyBtn">Créer la clé</button>
      </div>
    </div>
  </div>
  
  <!-- Modal de confirmation de suppression -->
  <div id="deleteModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">Confirmer la suppression</h2>
      </div>
      
      <div class="modal-body">
        <p>Êtes-vous sûr de vouloir supprimer cette application ? Cette action est irréversible.</p>
        <p><strong>Attention :</strong> Toutes les clés API associées à cette application seront également supprimées.</p>
      </div>
      
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" id="cancelDeleteBtn">Annuler</button>
        <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Supprimer</button>
      </div>
    </div>
  </div>
  
  <!-- Modal de confirmation de révocation de clé -->
  <div id="revokeKeyModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">Confirmer la révocation</h2>
      </div>
      
      <div class="modal-body">
        <p>Êtes-vous sûr de vouloir révoquer cette clé API ? Cette action est irréversible.</p>
        <p><strong>Attention :</strong> Une fois révoquée, cette clé ne pourra plus être utilisée pour accéder à l'API.</p>
      </div>
      
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" id="cancelRevokeBtn">Annuler</button>
        <button type="button" class="btn btn-danger" id="confirmRevokeBtn">Révoquer</button>
      </div>
    </div>
  </div>
  
  <!-- Alerte pour afficher la nouvelle clé créée -->
  <div class="modal" id="newKeyModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">Nouvelle clé API créée</h2>
      </div>
      
      <div class="modal-body">
        <div class="new-key-alert" style="display: block; margin-top: 0;">
          <h3><i class="fas fa-exclamation-circle"></i> Votre clé API a été créée avec succès</h3>
          <p>Copiez cette clé et conservez-la en lieu sûr. Par mesure de sécurité, elle ne sera plus jamais affichée.</p>
          <div class="new-key-value" id="newKeyValue">
            <span id="actualKeyValue">api_key_placeholder</span>
            <button class="copy-btn" id="copyKeyBtn"><i class="fas fa-copy"></i> Copier</button>
          </div>
          <p class="key-warning" style="color: #e74c3c; font-weight: 500;">Cette clé vous donne accès à des fonctionnalités et données sensibles. Ne la partagez pas et ne la publiez pas.</p>
        </div>
      </div>
      
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" id="closeNewKeyBtn">J'ai copié ma clé</button>
      </div>
    </div>
  </div>

  <footer class="footer">
    <div class="container">
      <div class="footer-text">
        &copy; 2025 FHIRHub - Service de conversion HL7 vers FHIR
      </div>
      <ul class="footer-links">
        <li><a href="/documentation.html">Documentation</a></li>
        <li><a href="/api-docs">API</a></li>
      </ul>
    </div>
  </footer>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Vérifier l'authentification
      const token = localStorage.getItem('token');
      if (!token) {
        window.location.href = '/login.html';
        return;
      }
      
      // Récupérer les informations de l'utilisateur
      const user = JSON.parse(localStorage.getItem('user') || '{}');
      
      // Vérifier si l'utilisateur est admin (seul l'admin peut gérer les applications)
      if (user.role !== 'admin') {
        // Afficher un message d'erreur explicatif et un bouton de retour
        const container = document.querySelector('.main-content .container');
        container.innerHTML = `
          <div class="alert alert-error" style="margin: 20px 0; padding: 20px; border-radius: 5px; background-color: #ffdddd; border-left: 5px solid #f44336; color: #333;">
            <h3 style="margin-top: 0; color: #d32f2f;">Accès restreint</h3>
            <p>Cette page est réservée aux administrateurs. Seuls les comptes disposant de droits d'administration peuvent gérer les applications et les clés API du système.</p>
            <p>Pour accéder à cette fonctionnalité, veuillez contacter votre administrateur système ou vous connecter avec un compte disposant des privilèges appropriés.</p>
            <button id="returnToDashboard" class="btn btn-primary" style="margin-top: 15px;">Retourner au tableau de bord</button>
          </div>
        `;
        
        // Ajouter l'événement pour retourner au tableau de bord
        document.getElementById('returnToDashboard').addEventListener('click', function() {
          window.location.href = '/dashboard.html';
        });
        
        return; // Arrêter l'exécution du reste du script
      }
      
      // Gestion de la déconnexion
      document.getElementById('logoutBtn').addEventListener('click', function(e) {
        e.preventDefault();
        localStorage.removeItem('token');
        localStorage.removeItem('user');
        window.location.href = '/login.html';
      });
      
      // Références aux modales
      const appModal = document.getElementById('appModal');
      const keyModal = document.getElementById('keyModal');
      const deleteModal = document.getElementById('deleteModal');
      const revokeKeyModal = document.getElementById('revokeKeyModal');
      const newKeyModal = document.getElementById('newKeyModal');
      
      // Gestionnaires d'événements pour les boutons
      document.getElementById('addAppBtn').addEventListener('click', showAddAppModal);
      document.getElementById('cancelAppBtn').addEventListener('click', () => closeModal(appModal));
      document.getElementById('saveAppBtn').addEventListener('click', saveApplication);
      document.getElementById('cancelKeyBtn').addEventListener('click', () => closeModal(keyModal));
      document.getElementById('saveKeyBtn').addEventListener('click', createApiKey);
      document.getElementById('cancelDeleteBtn').addEventListener('click', () => closeModal(deleteModal));
      document.getElementById('confirmDeleteBtn').addEventListener('click', deleteApplication);
      document.getElementById('cancelRevokeBtn').addEventListener('click', () => closeModal(revokeKeyModal));
      document.getElementById('confirmRevokeBtn').addEventListener('click', revokeApiKey);
      document.getElementById('closeNewKeyBtn').addEventListener('click', () => closeModal(newKeyModal));
      document.getElementById('copyKeyBtn').addEventListener('click', copyNewKey);
      
      // Fermer les modals en cliquant en dehors
      window.addEventListener('click', function(e) {
        if (e.target === appModal) closeModal(appModal);
        if (e.target === keyModal) closeModal(keyModal);
        if (e.target === deleteModal) closeModal(deleteModal);
        if (e.target === revokeKeyModal) closeModal(revokeKeyModal);
        if (e.target === newKeyModal) closeModal(newKeyModal);
      });
      
      // Charger les applications
      loadApplications();
      
      // Fonction pour charger la liste des applications
      async function loadApplications() {
        try {
          const response = await fetch('/api/applications', {
            headers: {
              'Authorization': `Bearer ${token}`
            }
          });
          
          if (!response.ok) {
            throw new Error('Erreur lors de la récupération des applications');
          }
          
          const data = await response.json();
          
          if (data.success && data.data && data.data.length > 0) {
            renderApplications(data.data);
            document.getElementById('noAppsMessage').style.display = 'none';
          } else {
            document.getElementById('applicationsList').innerHTML = '';
            document.getElementById('noAppsMessage').style.display = 'block';
          }
        } catch (error) {
          console.error('Erreur:', error);
          alert('Erreur lors de la récupération des applications: ' + error.message);
        }
      }
      
      // Fonction pour afficher les applications dans la liste
      function renderApplications(applications) {
        const appsList = document.getElementById('applicationsList');
        appsList.innerHTML = '';
        
        applications.forEach(app => {
          createAppCard(app);
        });
      }
      
      // Fonction pour créer une carte d'application
      function createAppCard(app) {
        const appsList = document.getElementById('applicationsList');
        let settings = {};
        try {
          settings = JSON.parse(app.settings || '{}');
        } catch (error) {
          console.error('Erreur de parsing des paramètres:', error);
        }
        
        const appCard = document.createElement('div');
        appCard.className = 'app-card';
        appCard.id = `app-${app.id}`;
        
        appCard.innerHTML = `
          <div class="app-header">
            <h2 class="app-title">${app.name}</h2>
            <p class="app-description">${app.description || 'Aucune description fournie'}</p>
            <div class="app-actions">
              <button class="btn-icon edit-app-btn" data-id="${app.id}" title="Modifier l'application">
                <i class="fas fa-edit"></i>
              </button>
              <button class="btn-icon delete-app-btn" data-id="${app.id}" title="Supprimer l'application">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </div>
          
          <div class="app-body">
            <div class="app-tabs">
              <div class="app-tab active" data-tab="info-${app.id}">Informations</div>
              <div class="app-tab" data-tab="keys-${app.id}">Clés API</div>
              <div class="app-tab" data-tab="usage-${app.id}">Utilisation</div>
            </div>
            
            <div class="app-tab-content active" id="info-${app.id}">
              <div class="app-info">
                <div class="app-info-item">
                  <div class="app-info-label">Création</div>
                  <div class="app-info-value">${new Date(app.created_at).toLocaleDateString()} ${new Date(app.created_at).toLocaleTimeString()}</div>
                </div>
                <div class="app-info-item">
                  <div class="app-info-label">Dernière mise à jour</div>
                  <div class="app-info-value">${app.updated_at ? new Date(app.updated_at).toLocaleDateString() + ' ' + new Date(app.updated_at).toLocaleTimeString() : 'Jamais'}</div>
                </div>
                <div class="app-info-item">
                  <div class="app-info-label">Limite quotidienne</div>
                  <div class="app-info-value">${settings.maxConversions || 1000} conversions/jour</div>
                </div>
                <div class="app-info-item">
                  <div class="app-info-label">Taille max. des messages</div>
                  <div class="app-info-value">${settings.maxMessageSize || 100000} octets</div>
                </div>
              </div>
              
              <div class="app-info-item">
                <div class="app-info-label">Origines CORS autorisées</div>
                <div class="app-info-value">${app.cors_origins || 'Aucune restriction'}</div>
              </div>
            </div>
            
            <div class="app-tab-content" id="keys-${app.id}">
              <div class="api-keys-list" id="keys-list-${app.id}">
                <p class="loading-keys">Chargement des clés API...</p>
              </div>
              
              <div class="btn-group">
                <button class="btn btn-primary generate-key-btn" data-app-id="${app.id}">
                  <i class="fas fa-key"></i> Générer une nouvelle clé
                </button>
              </div>
            </div>
            
            <div class="app-tab-content" id="usage-${app.id}">
              <div class="api-usage">
                <h3>Statistiques d'utilisation</h3>
                
                <div class="usage-stats">
                  <div class="usage-stat">
                    <div class="usage-value" id="total-conversions-${app.id}">--</div>
                    <div class="usage-label">Conversions totales</div>
                  </div>
                  <div class="usage-stat">
                    <div class="usage-value" id="daily-usage-${app.id}">--</div>
                    <div class="usage-label">Utilisation aujourd'hui</div>
                  </div>
                  <div class="usage-stat">
                    <div class="usage-value" id="monthly-usage-${app.id}">--</div>
                    <div class="usage-label">Utilisation ce mois</div>
                  </div>
                </div>
                
                <div class="usage-chart" id="usage-chart-${app.id}">
                  <p style="text-align: center; padding-top: 60px; color: #777;">Les graphiques d'utilisation seront disponibles dans une prochaine mise à jour.</p>
                </div>
              </div>
            </div>
          </div>
        `;
        
        appsList.appendChild(appCard);
        
        // Ajouter les gestionnaires d'événements pour les onglets
        const tabs = appCard.querySelectorAll('.app-tab');
        tabs.forEach(tab => {
          tab.addEventListener('click', function() {
            const tabId = this.getAttribute('data-tab');
            
            // Déactiver tous les onglets et le contenu
            appCard.querySelectorAll('.app-tab').forEach(t => t.classList.remove('active'));
            appCard.querySelectorAll('.app-tab-content').forEach(c => c.classList.remove('active'));
            
            // Activer l'onglet cliqué et son contenu
            this.classList.add('active');
            document.getElementById(tabId).classList.add('active');
            
            // Si c'est l'onglet des clés API, charger les clés
            if (tabId === `keys-${app.id}`) {
              loadApiKeys(app.id);
            }
            
            // Si c'est l'onglet d'utilisation, charger les statistiques
            if (tabId === `usage-${app.id}`) {
              loadUsageStats(app.id);
            }
          });
        });
        
        // Ajouter les gestionnaires d'événements pour les boutons d'action
        appCard.querySelector('.edit-app-btn').addEventListener('click', () => showEditAppModal(app));
        appCard.querySelector('.delete-app-btn').addEventListener('click', () => showDeleteAppModal(app.id));
        appCard.querySelector('.generate-key-btn').addEventListener('click', () => showAddKeyModal(app.id));
      }
      
      // Fonction pour charger les clés API d'une application
      async function loadApiKeys(appId) {
        try {
          const keysList = document.getElementById(`keys-list-${appId}`);
          if (!keysList) {
            console.error("Élément keys-list-" + appId + " introuvable");
            return;
          }
          
          keysList.innerHTML = '<p class="loading-keys">Chargement des clés API...</p>';
          
          const response = await fetch('/api/api-keys', {
            headers: {
              'Authorization': `Bearer ${token}`
            }
          });
          
          if (!response.ok) {
            throw new Error('Erreur lors de la récupération des clés API');
          }
          
          const data = await response.json();
          
          // La structure de réponse peut varier - vérifier si les données sont directement accessibles ou dans une propriété data
          const keys = Array.isArray(data) ? data : (data.data ? data.data : []);
          
          // Filtrer les clés pour cette application en convertissant les IDs en nombre
          const intAppId = parseInt(appId);
          const appKeys = keys.filter(key => parseInt(key.application_id) === intAppId);
          
          if (appKeys.length > 0) {
            let keysHtml = '';
              
              appKeys.forEach(key => {
                const status = key.is_active ? 
                  (key.expires_at && new Date(key.expires_at) < new Date() ? 
                    'expired' : 'active') : 'revoked';
                
                const statusText = status === 'active' ? 'Active' : 
                                  (status === 'expired' ? 'Expirée' : 'Révoquée');
                
                keysHtml += `
                  <div class="key-item">
                    <div class="key-info">
                      <div class="key-primary">
                        <div class="key-value">
                          <span class="key-masked">••••••••${key.key.substring(key.key.length - 4)}</span>
                        </div>
                        <span class="status-badge status-${status}">${statusText}</span>
                      </div>
                      <div class="key-secondary">
                        ${key.description || 'Aucune description'}
                        ${key.expires_at ? `· Expire le ${new Date(key.expires_at).toLocaleDateString()}` : ''}
                        · Créée le ${new Date(key.created_at).toLocaleDateString()}
                      </div>
                    </div>
                    <div class="key-actions">
                      ${status === 'active' ? `
                        <button class="btn btn-sm btn-danger revoke-key-btn" data-key-id="${key.id}">
                          <i class="fas fa-ban"></i> Révoquer
                        </button>
                      ` : ''}
                    </div>
                  </div>
                `;
              });
              
              keysList.innerHTML = keysHtml;
              
              // Ajouter les gestionnaires d'événements pour les boutons de révocation
              const revokeButtons = keysList.querySelectorAll('.revoke-key-btn');
              revokeButtons.forEach(button => {
                button.addEventListener('click', function() {
                  const keyId = this.getAttribute('data-key-id');
                  showRevokeKeyModal(keyId);
                });
              });
            } else {
              keysList.innerHTML = `
                <div style="text-align: center; padding: 20px; color: #777;">
                  <i class="fas fa-key" style="font-size: 24px; margin-bottom: 10px; opacity: 0.5;"></i>
                  <p>Aucune clé API pour cette application.</p>
                  <p>Générez une clé pour permettre l'accès à l'API.</p>
                </div>
              `;
            }
          // Il n'y a pas de propriété success dans la réponse directe des API keys
        } catch (error) {
          console.error('Erreur:', error);
          const keysList = document.getElementById(`keys-list-${appId}`);
          keysList.innerHTML = `
            <div style="text-align: center; padding: 20px; color: #e74c3c;">
              <i class="fas fa-exclamation-circle"></i>
              <p>Erreur lors du chargement des clés API: ${error.message}</p>
            </div>
          `;
        }
      }
      
      // Fonction pour charger les statistiques d'utilisation d'une application
      async function loadUsageStats(appId) {
        try {
          // Vérifier si les éléments existent
          const totalElement = document.getElementById(`total-conversions-${appId}`);
          const dailyElement = document.getElementById(`daily-usage-${appId}`);
          const monthlyElement = document.getElementById(`monthly-usage-${appId}`);
          
          if (!totalElement || !dailyElement || !monthlyElement) {
            console.warn(`Les éléments de statistiques pour l'application ${appId} n'existent pas`);
            return;
          }
          
          // Mettre à jour les éléments d'interface
          totalElement.textContent = '...';
          dailyElement.textContent = '...';
          monthlyElement.textContent = '...';
          
          // Récupérer les statistiques d'utilisation
          try {
            const response = await fetch(`/api/applications/${appId}/usage`, {
              headers: {
                'Authorization': `Bearer ${token}`
              }
            });
            
            if (!response.ok) {
              // Si l'endpoint n'existe pas ou renvoie une erreur, utiliser des valeurs par défaut
              console.log(`API /applications/${appId}/usage non disponible (${response.status}). Utilisation de valeurs par défaut.`);
              totalElement.textContent = '0';
              dailyElement.textContent = '0';
              monthlyElement.textContent = '0';
              return;
            }
            
            const data = await response.json();
            
            if (data.success && data.data) {
              totalElement.textContent = data.data.total || '0';
              dailyElement.textContent = data.data.today || '0';
              monthlyElement.textContent = data.data.month || '0';
            } else {
              // Structure de réponse alternative possible
              totalElement.textContent = data.total || '0';
              dailyElement.textContent = data.today || '0';
              monthlyElement.textContent = data.month || '0';
            }
          } catch (fetchError) {
            console.warn(`Erreur lors de la récupération des statistiques pour l'application ${appId}:`, fetchError);
            // Afficher des valeurs par défaut en cas d'erreur
            totalElement.textContent = '0';
            dailyElement.textContent = '0';
            monthlyElement.textContent = '0';
          }
        } catch (error) {
          console.error('Erreur dans loadUsageStats:', error);
        }
      }
      
      // Afficher la modal pour ajouter une application
      function showAddAppModal() {
        document.getElementById('modalTitle').textContent = 'Nouvelle application';
        document.getElementById('appId').value = '';
        document.getElementById('appForm').reset();
        document.getElementById('appMaxConversions').value = '1000';
        document.getElementById('appMaxMessageSize').value = '100000';
        openModal(appModal);
      }
      
      // Afficher la modal pour modifier une application
      function showEditAppModal(app) {
        document.getElementById('modalTitle').textContent = 'Modifier l\'application';
        document.getElementById('appId').value = app.id;
        document.getElementById('appName').value = app.name;
        document.getElementById('appDescription').value = app.description || '';
        document.getElementById('appCorsOrigins').value = app.cors_origins || '';
        
        let settings = {};
        try {
          settings = JSON.parse(app.settings || '{}');
        } catch (error) {
          console.error('Erreur de parsing des paramètres:', error);
        }
        
        document.getElementById('appMaxConversions').value = settings.maxConversions || 1000;
        document.getElementById('appMaxMessageSize').value = settings.maxMessageSize || 100000;
        
        openModal(appModal);
      }
      
      // Afficher la modal pour ajouter une clé API
      function showAddKeyModal(appId) {
        document.getElementById('keyAppId').value = appId;
        document.getElementById('keyForm').reset();
        document.getElementById('keyActive').checked = true;
        openModal(keyModal);
      }
      
      // Afficher la modal pour confirmer la suppression d'une application
      function showDeleteAppModal(appId) {
        document.getElementById('confirmDeleteBtn').setAttribute('data-id', appId);
        openModal(deleteModal);
      }
      
      // Afficher la modal pour confirmer la révocation d'une clé API
      function showRevokeKeyModal(keyId) {
        document.getElementById('confirmRevokeBtn').setAttribute('data-id', keyId);
        openModal(revokeKeyModal);
      }
      
      // Enregistrer une application (création ou modification)
      async function saveApplication() {
        try {
          const appId = document.getElementById('appId').value;
          const isNewApp = !appId;
          
          const appData = {
            name: document.getElementById('appName').value,
            description: document.getElementById('appDescription').value,
            cors_origins: document.getElementById('appCorsOrigins').value,
            settings: JSON.stringify({
              maxConversions: parseInt(document.getElementById('appMaxConversions').value),
              maxMessageSize: parseInt(document.getElementById('appMaxMessageSize').value)
            })
          };
          
          const url = isNewApp ? '/api/applications' : `/api/applications/${appId}`;
          const method = isNewApp ? 'POST' : 'PUT';
          
          const response = await fetch(url, {
            method: method,
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify(appData)
          });
          
          if (!response.ok) {
            throw new Error('Erreur lors de l\'enregistrement de l\'application');
          }
          
          const data = await response.json();
          
          if (data.success) {
            closeModal(appModal);
            loadApplications();
            alert(isNewApp ? 'Application créée avec succès' : 'Application mise à jour avec succès');
          } else {
            throw new Error(data.message || 'Erreur lors de l\'enregistrement de l\'application');
          }
        } catch (error) {
          console.error('Erreur:', error);
          alert('Erreur lors de l\'enregistrement de l\'application: ' + error.message);
        }
      }
      
      // Créer une nouvelle clé API
      async function createApiKey() {
        try {
          const appId = document.getElementById('keyAppId').value;
          
          const keyData = {
            application_id: parseInt(appId),
            description: document.getElementById('keyDescription').value,
            expires_at: document.getElementById('keyExpires').value || null,
            is_active: document.getElementById('keyActive').checked
          };
          
          const response = await fetch('/api/api-keys', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify(keyData)
          });
          
          if (!response.ok) {
            throw new Error('Erreur lors de la création de la clé API');
          }
          
          const data = await response.json();
          
          // Fermer le modal de création de clé
          closeModal(keyModal);
          
          // Afficher la clé à l'utilisateur
          console.log("Réponse de création de clé API:", data);
          // Déterminer où se trouve la valeur de la clé dans la réponse
          let keyValue = '';
          if (data.key) {
            keyValue = data.key;
          } else if (data.data && data.data.key) {
            keyValue = data.data.key;
          } else {
            // Si on ne trouve pas la clé dans la structure habituelle, chercher plus en profondeur
            const keyProp = Object.keys(data).find(key => typeof data[key] === 'string' && data[key].length > 20);
            if (keyProp) {
              keyValue = data[keyProp];
            }
          }
          
          if (keyValue) {
            document.getElementById('actualKeyValue').textContent = keyValue;
            openModal(newKeyModal);
          } else {
            alert("La clé API a été créée avec succès, mais n'a pas pu être affichée. Vous pouvez la trouver dans la liste des clés API.")
          }
          
          // Recharger toutes les applications pour mettre à jour les listes de clés API
          await loadApplications();
          
          // Recharger aussi spécifiquement les clés de cette application
          loadApiKeys(appId);
        } catch (error) {
          console.error('Erreur:', error);
          alert('Erreur lors de la création de la clé API: ' + error.message);
        }
      }
      
      // Supprimer une application
      async function deleteApplication() {
        try {
          const appId = document.getElementById('confirmDeleteBtn').getAttribute('data-id');
          
          const response = await fetch(`/api/applications/${appId}`, {
            method: 'DELETE',
            headers: {
              'Authorization': `Bearer ${token}`
            }
          });
          
          if (!response.ok) {
            throw new Error('Erreur lors de la suppression de l\'application');
          }
          
          const data = await response.json();
          
          if (data.success) {
            closeModal(deleteModal);
            
            // Supprimer la carte de l'application
            const appCard = document.getElementById(`app-${appId}`);
            if (appCard) appCard.remove();
            
            // Vérifier s'il n'y a plus d'applications
            const appsList = document.getElementById('applicationsList');
            if (appsList.children.length === 0) {
              document.getElementById('noAppsMessage').style.display = 'block';
            }
            
            alert('Application supprimée avec succès');
          } else {
            throw new Error(data.message || 'Erreur lors de la suppression de l\'application');
          }
        } catch (error) {
          console.error('Erreur:', error);
          alert('Erreur lors de la suppression de l\'application: ' + error.message);
        }
      }
      
      // Révoquer une clé API
      async function revokeApiKey() {
        try {
          const keyId = document.getElementById('confirmRevokeBtn').getAttribute('data-id');
          
          const response = await fetch(`/api/api-keys/${keyId}/revoke`, {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${token}`
            }
          });
          
          if (!response.ok) {
            throw new Error('Erreur lors de la révocation de la clé API');
          }
          
          const data = await response.json();
          
          if (data.success) {
            closeModal(revokeKeyModal);
            
            // Trouver l'application associée à cette clé
            const revokeButton = document.querySelector(`.revoke-key-btn[data-key-id="${keyId}"]`);
            if (revokeButton) {
              const keyItem = revokeButton.closest('.key-item');
              const keysList = keyItem.closest('.api-keys-list');
              const appId = keysList.id.replace('keys-list-', '');
              
              // Recharger les clés API pour l'application
              loadApiKeys(appId);
            }
            
            alert('Clé API révoquée avec succès');
          } else {
            throw new Error(data.message || 'Erreur lors de la révocation de la clé API');
          }
        } catch (error) {
          console.error('Erreur:', error);
          alert('Erreur lors de la révocation de la clé API: ' + error.message);
        }
      }
      
      // Copier la nouvelle clé API dans le presse-papiers
      function copyNewKey() {
        const keyValue = document.getElementById('actualKeyValue').textContent;
        navigator.clipboard.writeText(keyValue).then(() => {
          alert('Clé API copiée dans le presse-papiers');
        }).catch(err => {
          console.error('Erreur lors de la copie de la clé:', err);
          alert('Erreur lors de la copie de la clé. Veuillez sélectionner et copier manuellement.');
        });
      }
      
      // Fonctions génériques pour la gestion des modales
      function openModal(modal) {
        modal.style.display = 'flex';
      }
      
      function closeModal(modal) {
        modal.style.display = 'none';
      }
    });
  </script>
  
  <!-- Script pour la gestion du menu déroulant -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Gestion du clic et du survol sur les menus déroulants
      const dropdowns = document.querySelectorAll('.dropdown');
      
      // Fonction pour fermer tous les menus déroulants
      function closeAllDropdowns() {
        dropdowns.forEach(dropdown => {
          dropdown.classList.remove('active');
        });
      }
      
      // Événement pour fermer les menus déroulants lors d'un clic en dehors
      document.addEventListener('click', function(event) {
        const target = event.target;
        // Si le clic n'est pas dans un menu déroulant, fermer tous les menus
        if (!target.closest('.dropdown')) {
          closeAllDropdowns();
        }
      });
      
      // Pour chaque menu déroulant
      dropdowns.forEach(dropdown => {
        const toggle = dropdown.querySelector('.dropdown-toggle');
        
        // Gestion du clic sur le bouton du menu déroulant
        toggle.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation(); // Empêche la propagation de l'événement
          
          // Si le menu est déjà actif, le fermer
          if (dropdown.classList.contains('active')) {
            dropdown.classList.remove('active');
          } else {
            // Sinon, fermer tous les autres et ouvrir celui-ci
            closeAllDropdowns();
            dropdown.classList.add('active');
            
            // Log pour déboguer
            console.log('Menu déroulant ouvert');
          }
        });
      });
    });
  </script>
</body>
</html>