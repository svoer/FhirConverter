<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Terminologies - Contenu</title>
  <link rel="stylesheet" href="/css/styles.css">
  <link rel="stylesheet" href="/css/admin.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
  <style>
    body {
      padding: 0;
      margin: 0;
    }
    
    .terminologies-container {
      margin-top: 0;
    }
    
    .page-header {
      display: none;
    }
  </style>
</head>
<body>
  <div class="terminologies-container">
    <div class="terminology-tabs">
      <div class="tab active" data-tab="installed">Terminologies installées</div>
      <div class="tab" data-tab="french">Terminologies françaises</div>
      <div class="tab" data-tab="custom">Terminologies personnalisées</div>
    </div>
    
    <div class="terminology-content">
      <div class="tab-content active" id="installed-tab">
        <div class="terminology-section">
          <h3>Terminologies installées</h3>
          <p>Liste des fichiers de terminologie disponibles dans le système.</p>
          
          <div class="terminology-files" id="terminology-files">
            <div class="loading">
              <i class="fas fa-spinner fa-spin"></i> Chargement des terminologies...
            </div>
          </div>
        </div>
      </div>
      
      <div class="tab-content" id="french-tab">
        <div class="terminology-section">
          <h3>Terminologies françaises</h3>
          <p>Mappings spécifiques à la France, conformes aux exigences de l'ANS.</p>
          
          <div class="french-terminology-content" id="french-terminology-content">
            <div class="loading">
              <i class="fas fa-spinner fa-spin"></i> Chargement des terminologies françaises...
            </div>
          </div>
        </div>
      </div>
      
      <div class="tab-content" id="custom-tab">
        <div class="terminology-section">
          <h3>Terminologies personnalisées</h3>
          <p>Créez et gérez des mappings de terminologie personnalisés pour votre organisation.</p>
          
          <button id="add-mapping-btn" class="btn btn-primary"><i class="fas fa-plus"></i> Ajouter un mapping</button>
          
          <div class="custom-mappings" id="custom-mappings">
            <div class="no-mappings-message">
              <p>Aucun mapping personnalisé n'a été ajouté.</p>
              <p>Cliquez sur "Ajouter un mapping" pour créer votre premier mapping personnalisé.</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Modal d'importation de terminologie -->
  <div id="import-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">Importer une terminologie</h2>
      </div>
      
      <div class="modal-body">
        <form id="import-form" enctype="multipart/form-data">
          <div class="form-group">
            <label for="terminology-type" class="form-label">Type de terminologie</label>
            <select id="terminology-type" class="form-select" required>
              <option value="code-system">Code System</option>
              <option value="value-set">Value Set</option>
              <option value="concept-map">Concept Map</option>
              <option value="mapping-file">Fichier de mapping</option>
            </select>
          </div>
          
          <div class="form-group">
            <label for="import-name" class="form-label">Nom de la terminologie</label>
            <input type="text" id="import-name" class="form-input" required placeholder="ex: LOINC_FR, CIM10, TA_ASIP">
          </div>
          
          <div class="form-group">
            <label for="import-description" class="form-label">Description</label>
            <textarea id="import-description" class="form-textarea" rows="3" placeholder="Description de la terminologie et de son utilisation..."></textarea>
          </div>
          
          <div class="form-group">
            <label for="import-file" class="form-label">Fichier</label>
            <div class="file-input-container">
              <input type="file" id="import-file" class="file-input" required>
              <div class="file-input-button">
                <i class="fas fa-upload"></i> Choisir un fichier
              </div>
              <span class="file-name" id="file-name">Aucun fichier sélectionné</span>
            </div>
            <small class="form-text">Formats acceptés: JSON, XML, CSV</small>
          </div>
          
          <div class="form-group">
            <div class="checkbox-container">
              <input type="checkbox" id="import-active" checked>
              <label for="import-active">Activer immédiatement cette terminologie</label>
            </div>
          </div>
        </form>
      </div>
      
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" id="cancel-import-btn">Annuler</button>
        <button type="button" class="btn btn-primary" id="save-import-btn">Importer</button>
      </div>
    </div>
  </div>
  
  <!-- Modal d'ajout de mapping personnalisé -->
  <div id="mapping-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">Ajouter un mapping personnalisé</h2>
      </div>
      
      <div class="modal-body">
        <form id="mapping-form">
          <div class="form-group">
            <label for="mapping-name" class="form-label">Nom du mapping</label>
            <input type="text" id="mapping-name" class="form-input" required>
          </div>
          
          <div class="form-group">
            <label for="source-system" class="form-label">Système source</label>
            <input type="text" id="source-system" class="form-input" required placeholder="ex: http://loinc.org">
          </div>
          
          <div class="form-group">
            <label for="target-system" class="form-label">Système cible</label>
            <input type="text" id="target-system" class="form-input" required placeholder="ex: http://snomed.info/sct">
          </div>
          
          <div class="mapping-entries">
            <div class="mapping-entry-header">
              <div>Code source</div>
              <div>Affichage source</div>
              <div>Code cible</div>
              <div>Affichage cible</div>
              <div></div>
            </div>
            
            <div class="mapping-entries-container" id="mapping-entries-container">
              <!-- Les entrées de mapping seront ajoutées ici -->
              <div class="mapping-entry" data-entry-id="1">
                <input type="text" class="source-code" placeholder="Code source" required>
                <input type="text" class="source-display" placeholder="Affichage">
                <input type="text" class="target-code" placeholder="Code cible" required>
                <input type="text" class="target-display" placeholder="Affichage">
                <button type="button" class="remove-entry-btn"><i class="fas fa-times"></i></button>
              </div>
            </div>
            
            <button type="button" id="add-entry-btn" class="btn btn-outline">
              <i class="fas fa-plus"></i> Ajouter une entrée
            </button>
          </div>
        </form>
      </div>
      
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" id="cancel-mapping-btn">Annuler</button>
        <button type="button" class="btn btn-primary" id="save-mapping-btn">Enregistrer</button>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Onglets de terminologie
      const tabs = document.querySelectorAll('.terminology-tabs .tab');
      tabs.forEach(tab => {
        tab.addEventListener('click', function() {
          // Retirer la classe active de tous les onglets
          tabs.forEach(t => t.classList.remove('active'));
          
          // Ajouter la classe active à l'onglet cliqué
          this.classList.add('active');
          
          // Afficher le contenu correspondant
          const tabName = this.getAttribute('data-tab');
          const tabContents = document.querySelectorAll('.tab-content');
          tabContents.forEach(content => {
            content.classList.remove('active');
          });
          document.getElementById(`${tabName}-tab`).classList.add('active');
        });
      });
      
      // Charger les terminologies
      loadTerminologyFiles();
      loadFrenchTerminology();
      
      // Gestionnaire pour l'importation de fichier
      document.getElementById('import-file').addEventListener('change', function() {
        const fileName = this.files[0]?.name || 'Aucun fichier sélectionné';
        document.getElementById('file-name').textContent = fileName;
      });
      
      // Gestionnaires pour les modales
      document.getElementById('cancel-import-btn').addEventListener('click', closeImportModal);
      document.getElementById('save-import-btn').addEventListener('click', importTerminology);
      document.getElementById('add-mapping-btn').addEventListener('click', openMappingModal);
      document.getElementById('cancel-mapping-btn').addEventListener('click', closeMappingModal);
      document.getElementById('save-mapping-btn').addEventListener('click', saveMapping);
      document.getElementById('add-entry-btn').addEventListener('click', addMappingEntry);
      
      // Exposer la fonction openImportModal pour qu'elle puisse être appelée depuis la page parent
      window.openImportModal = openImportModal;
    });
    
    function openImportModal() {
      // Réinitialiser le formulaire
      document.getElementById('import-form').reset();
      document.getElementById('file-name').textContent = 'Aucun fichier sélectionné';
      
      // Afficher la modale
      document.getElementById('import-modal').style.display = 'block';
    }
    
    function closeImportModal() {
      document.getElementById('import-modal').style.display = 'none';
    }
    
    function openMappingModal() {
      // Réinitialiser le formulaire
      document.getElementById('mapping-form').reset();
      
      // Réinitialiser les entrées de mapping
      const entriesContainer = document.getElementById('mapping-entries-container');
      entriesContainer.innerHTML = `
        <div class="mapping-entry" data-entry-id="1">
          <input type="text" class="source-code" placeholder="Code source" required>
          <input type="text" class="source-display" placeholder="Affichage">
          <input type="text" class="target-code" placeholder="Code cible" required>
          <input type="text" class="target-display" placeholder="Affichage">
          <button type="button" class="remove-entry-btn"><i class="fas fa-times"></i></button>
        </div>
      `;
      
      // Ajouter l'événement de suppression
      attachRemoveEntryEvents();
      
      // Afficher la modale
      document.getElementById('mapping-modal').style.display = 'block';
    }
    
    function closeMappingModal() {
      document.getElementById('mapping-modal').style.display = 'none';
    }
    
    function addMappingEntry() {
      const entriesContainer = document.getElementById('mapping-entries-container');
      const entryCount = entriesContainer.querySelectorAll('.mapping-entry').length;
      const entryId = entryCount + 1;
      
      const entryDiv = document.createElement('div');
      entryDiv.className = 'mapping-entry';
      entryDiv.setAttribute('data-entry-id', entryId);
      entryDiv.innerHTML = `
        <input type="text" class="source-code" placeholder="Code source" required>
        <input type="text" class="source-display" placeholder="Affichage">
        <input type="text" class="target-code" placeholder="Code cible" required>
        <input type="text" class="target-display" placeholder="Affichage">
        <button type="button" class="remove-entry-btn"><i class="fas fa-times"></i></button>
      `;
      
      entriesContainer.appendChild(entryDiv);
      
      // Ajouter l'événement de suppression
      attachRemoveEntryEvents();
    }
    
    function attachRemoveEntryEvents() {
      document.querySelectorAll('.remove-entry-btn').forEach(button => {
        button.addEventListener('click', function() {
          const entry = this.closest('.mapping-entry');
          
          // Ne pas supprimer s'il n'y a qu'une seule entrée
          const entriesCount = document.querySelectorAll('.mapping-entry').length;
          if (entriesCount > 1) {
            entry.remove();
          }
        });
      });
    }
    
    function loadTerminologyFiles() {
      // Utilisation de la fonction d'authentification avec la clé API
      if (window.parent.FHIRHubAuth && window.parent.FHIRHubAuth.fetchWithAuth) {
        window.parent.FHIRHubAuth.fetchWithAuth('/api/terminology/files', { method: 'GET' }, true)
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              renderTerminologyFiles(data.data);
            } else {
              showTerminologyError('installed', 'Erreur lors du chargement des terminologies.');
            }
          })
          .catch(error => {
            console.error('Erreur:', error);
            showTerminologyError('installed', 'Une erreur est survenue lors de la récupération des terminologies.');
          });
      } else {
        // Fallback si la fonction d'authentification n'est pas disponible
        fetch('/api/terminology/files', {
          method: 'GET',
          headers: {
            'X-API-KEY': 'dev-key'
          }
        })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          renderTerminologyFiles(data.data);
        } else {
          showTerminologyError('installed', 'Erreur lors du chargement des terminologies.');
        }
      })
      .catch(error => {
        console.error('Erreur:', error);
        showTerminologyError('installed', 'Une erreur est survenue lors de la récupération des terminologies.');
      });
    }
    
    function loadFrenchTerminology() {
      // Utilisation de la fonction d'authentification avec la clé API
      if (window.parent.FHIRHubAuth && window.parent.FHIRHubAuth.fetchWithAuth) {
        window.parent.FHIRHubAuth.fetchWithAuth('/api/terminology/french', { method: 'GET' }, true)
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              renderFrenchTerminology(data.data);
            } else {
              showTerminologyError('french', 'Erreur lors du chargement des terminologies françaises.');
            }
          })
          .catch(error => {
            console.error('Erreur:', error);
            showTerminologyError('french', 'Une erreur est survenue lors de la récupération des terminologies françaises.');
          });
      } else {
        // Fallback si la fonction d'authentification n'est pas disponible
        fetch('/api/terminology/french', {
          method: 'GET',
          headers: {
            'X-API-KEY': 'dev-key'
          }
        })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          renderFrenchTerminology(data.data);
        } else {
          showTerminologyError('french', 'Erreur lors du chargement des terminologies françaises.');
        }
      })
      .catch(error => {
        console.error('Erreur:', error);
        showTerminologyError('french', 'Une erreur est survenue lors de la récupération des terminologies françaises.');
      });
    }
    
    function renderTerminologyFiles(files) {
      const container = document.getElementById('terminology-files');
      container.innerHTML = '';
      
      if (files.length === 0) {
        container.innerHTML = '<div class="no-data">Aucun fichier de terminologie trouvé.</div>';
        return;
      }
      
      const table = document.createElement('table');
      table.className = 'terminology-table';
      
      // En-tête du tableau
      const thead = document.createElement('thead');
      thead.innerHTML = `
        <tr>
          <th>Nom</th>
          <th>Type</th>
          <th>Date d'installation</th>
          <th>Version</th>
          <th>Actions</th>
        </tr>
      `;
      table.appendChild(thead);
      
      // Corps du tableau
      const tbody = document.createElement('tbody');
      files.forEach(file => {
        const row = document.createElement('tr');
        
        // Formater la date
        const date = new Date(file.installed_date);
        const formattedDate = date.toLocaleDateString('fr-FR');
        
        row.innerHTML = `
          <td>${file.name}</td>
          <td><span class="badge ${file.type.toLowerCase()}-badge">${file.type}</span></td>
          <td>${formattedDate}</td>
          <td>${file.version || '-'}</td>
          <td>
            <button class="action-btn view-btn" data-id="${file.id}">
              <i class="fas fa-eye"></i> Voir
            </button>
            <button class="action-btn delete-btn" data-id="${file.id}" data-name="${file.name}">
              <i class="fas fa-trash-alt"></i> Supprimer
            </button>
          </td>
        `;
        
        tbody.appendChild(row);
      });
      
      table.appendChild(tbody);
      container.appendChild(table);
      
      // Ajouter les gestionnaires d'événements
      document.querySelectorAll('.view-btn').forEach(button => {
        button.addEventListener('click', function() {
          const fileId = this.getAttribute('data-id');
          viewTerminologyFile(fileId);
        });
      });
      
      document.querySelectorAll('.delete-btn').forEach(button => {
        button.addEventListener('click', function() {
          const fileId = this.getAttribute('data-id');
          const fileName = this.getAttribute('data-name');
          confirmDeleteTerminology(fileId, fileName);
        });
      });
    }
    
    function renderFrenchTerminology(mappings) {
      const container = document.getElementById('french-terminology-content');
      container.innerHTML = '';
      
      if (!mappings || Object.keys(mappings).length === 0) {
        container.innerHTML = '<div class="no-data">Aucune terminologie française trouvée.</div>';
        return;
      }
      
      // Créer les tableaux pour chaque type de mapping
      Object.entries(mappings).forEach(([category, categoryMappings]) => {
        const categorySection = document.createElement('div');
        categorySection.className = 'terminology-category';
        
        const categoryTitle = document.createElement('h4');
        categoryTitle.textContent = formatCategoryTitle(category);
        categorySection.appendChild(categoryTitle);
        
        const table = document.createElement('table');
        table.className = 'terminology-table';
        
        // En-tête du tableau
        const thead = document.createElement('thead');
        thead.innerHTML = `
          <tr>
            <th>Code source</th>
            <th>Description</th>
            <th>Code cible</th>
            <th>Système cible</th>
          </tr>
        `;
        table.appendChild(thead);
        
        // Corps du tableau
        const tbody = document.createElement('tbody');
        Object.entries(categoryMappings).forEach(([sourceCode, mapping]) => {
          const row = document.createElement('tr');
          
          row.innerHTML = `
            <td>${sourceCode}</td>
            <td>${mapping.description || '-'}</td>
            <td>${mapping.target_code || '-'}</td>
            <td>${mapping.target_system || '-'}</td>
          `;
          
          tbody.appendChild(row);
        });
        
        table.appendChild(tbody);
        categorySection.appendChild(table);
        container.appendChild(categorySection);
      });
    }
    
    function formatCategoryTitle(category) {
      switch (category) {
        case 'administrative_sex':
          return 'Sexe administratif';
        case 'marital_status':
          return 'État civil';
        case 'patient_class':
          return 'Classe du patient';
        case 'admission_type':
          return 'Type d\'admission';
        case 'encounter_status':
          return 'Statut de la rencontre';
        case 'identifier_type':
          return 'Type d\'identifiant';
        default:
          return category.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
      }
    }
    
    function importTerminology() {
      // À implémenter
      alert('Fonctionnalité d\'importation non implémentée dans cette démonstration.');
      closeImportModal();
    }
    
    function saveMapping() {
      // À implémenter
      alert('Fonctionnalité de mapping personnalisé non implémentée dans cette démonstration.');
      closeMappingModal();
    }
    
    function viewTerminologyFile(fileId) {
      // À implémenter
      alert(`Affichage du fichier de terminologie ID: ${fileId}`);
    }
    
    function confirmDeleteTerminology(fileId, fileName) {
      // À implémenter
      if (confirm(`Êtes-vous sûr de vouloir supprimer la terminologie "${fileName}" ?`)) {
        alert(`Suppression de la terminologie ID: ${fileId}`);
        loadTerminologyFiles();
      }
    }
    
    function showTerminologyError(tab, message) {
      const container = document.getElementById(`${tab}-tab`).querySelector('.loading');
      if (container) {
        container.innerHTML = `<div class="error-message">${message}</div>`;
      }
    }
  </script>
</body>
</html>