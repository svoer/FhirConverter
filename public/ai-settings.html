<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Paramètres IA - FHIRHub</title>
  <link rel="stylesheet" href="/css/styles.css">
  <link rel="stylesheet" href="/css/admin.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="/js/auth-utils.js" defer></script>
  <style>
    .ai-card {
      margin-bottom: 1.5rem;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      padding: 1rem;
      background-color: #fff;
      box-shadow: var(--box-shadow);
      transition: all 0.3s ease;
    }
    
    .ai-card:hover {
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    }
    
    .ai-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.5rem;
      border-bottom: 1px solid var(--border-color);
      padding-bottom: 0.5rem;
    }
    
    .ai-card h3 {
      margin: 0;
      color: var(--primary-color);
    }
    
    .ai-card-body {
      margin-top: 1rem;
    }
    
    .ai-provider-icon {
      font-size: 1.5rem;
      margin-right: 0.5rem;
      vertical-align: middle;
    }
    
    .ai-status {
      font-size: 0.8rem;
      padding: 0.25rem 0.5rem;
      border-radius: 20px;
      color: white;
      text-transform: uppercase;
      font-weight: bold;
    }
    
    .ai-status-active {
      background-color: #2ecc71;
    }
    
    .ai-status-inactive {
      background-color: #e74c3c;
    }
    
    .ai-status-pending {
      background-color: #f39c12;
    }
    
    .ai-card-info {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 0.5rem;
    }
    
    .ai-card-info span {
      color: #777;
    }
    
    .ai-form-row {
      display: flex;
      margin-bottom: 1rem;
    }
    
    .ai-form-column {
      flex: 1;
      margin-right: 1rem;
    }
    
    .ai-form-column:last-child {
      margin-right: 0;
    }
    
    .ai-provider-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }
    
    .ai-provider-card {
      border: 1px solid var(--border-color);
      border-radius: 4px;
      padding: 1rem;
      background-color: #fff;
      box-shadow: var(--box-shadow);
      transition: all 0.3s ease;
      cursor: pointer;
      text-align: center;
    }
    
    .ai-provider-card:hover {
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      transform: translateY(-2px);
    }
    
    .ai-provider-logo {
      width: 80px;
      height: 80px;
      margin: 0 auto 1rem;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 3rem;
      color: var(--primary-color);
    }
    
    .ai-provider-title {
      font-weight: bold;
      margin-bottom: 0.5rem;
    }
    
    .ai-provider-description {
      font-size: 0.9rem;
      color: #777;
    }
    
    .test-result {
      margin-top: 1rem;
      padding: 1rem;
      border-radius: 4px;
      font-size: 0.9rem;
    }
    
    .test-success {
      background-color: rgba(46, 204, 113, 0.15);
      border: 1px solid rgba(46, 204, 113, 0.3);
      color: #27ae60;
    }
    
    .test-error {
      background-color: rgba(231, 76, 60, 0.15);
      border: 1px solid rgba(231, 76, 60, 0.3);
      color: #c0392b;
    }
    
    .api-key-field {
      position: relative;
    }
    
    .api-key-input {
      padding-right: 3rem;
    }
    
    .toggle-password {
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      cursor: pointer;
      color: #777;
    }
    
    .toggle-password:hover {
      color: var(--primary-color);
    }
    
    .radio-group {
      display: flex;
      align-items: center;
      margin-top: 0.5rem;
    }
    
    .radio-option {
      margin-right: 1rem;
      display: flex;
      align-items: center;
    }
    
    .radio-option input {
      margin-right: 0.5rem;
    }
  </style>
</head>
<body>
  <header class="header">
    <div class="container">
      <div class="logo">
        <img src="/img/flame-icon-white.svg" alt="FHIRHub Logo" />
        FHIRHub
      </div>
      <ul class="nav-menu">
        <li><a href="/dashboard.html"><i class="fas fa-chart-line"></i> Tableau de bord</a></li>
        <li><a href="/convert.html"><i class="fas fa-exchange-alt"></i> Conversion</a></li>
        <li><a href="/application-management.html"><i class="fas fa-th"></i> Applications</a></li>
        <li><a href="/workflows.html"><i class="fas fa-project-diagram"></i> Workflows</a></li>
        <li class="dropdown">
          <a href="#" class="dropdown-toggle active"><i class="fas fa-cog"></i> Paramètres <i class="fas fa-caret-down"></i></a>
          <ul class="dropdown-menu">
            <li><a href="/users.html"><i class="fas fa-users"></i> Utilisateurs</a></li>
            <li><a href="/terminologies.html"><i class="fas fa-book-medical"></i> Terminologies</a></li>
            <li><a href="/ai-settings.html" class="active"><i class="fas fa-robot"></i> Paramètres IA</a></li>
          </ul>
        </li>
        <li><a href="/documentation.html"><i class="fas fa-file-alt"></i> Documentation</a></li>
        <li><a href="/api-docs/"><i class="fas fa-code"></i> API</a></li>
        <li><a href="#" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Déconnexion</a></li>
      </ul>
    </div>
  </header>

  <div class="main-content">
    <div class="container">
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">Paramètres des API d'Intelligence Artificielle</h2>
          <button class="btn btn-primary" id="add-provider-button" onclick="showProviderSelection()">
            <i class="fas fa-plus"></i> Ajouter une API
          </button>
        </div>
        <div class="card-body">
          <p>
            Gérez vos connexions aux API d'IA pour améliorer les fonctionnalités de FHIRHub. 
            Les API configurées peuvent être utilisées pour l'assistance utilisateur et les fonctionnalités de support.
          </p>
          
          <!-- Liste des APIs d'IA configurées -->
          <div id="api-list" class="api-list">
            <div class="loading-spinner" id="loading-spinner">
              <i class="fas fa-spinner fa-spin"></i> Chargement des API d'IA...
            </div>
            <div id="no-apis" class="alert alert-info hidden">
              Aucune API d'IA configurée. Ajoutez une nouvelle API pour commencer.
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal pour la sélection du fournisseur d'IA -->
  <div class="modal" id="provider-selection-modal">
    <div class="modal-content large-modal">
      <div class="modal-header">
        <h3>Choisir un fournisseur d'IA</h3>
        <span class="close">&times;</span>
      </div>
      <div class="modal-body">
        <p>Sélectionnez un fournisseur d'IA pour configurer une nouvelle API :</p>
        <div class="ai-provider-list" id="provider-list">
          <!-- Liste des fournisseurs générée dynamiquement -->
          <div class="loading-spinner">
            <i class="fas fa-spinner fa-spin"></i> Chargement des fournisseurs...
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal pour ajouter/modifier une API d'IA -->
  <div class="modal" id="provider-modal">
    <div class="modal-content large-modal">
      <div class="modal-header">
        <h3 id="provider-modal-title">Configurer une API d'IA</h3>
        <span class="close">&times;</span>
      </div>
      <div class="modal-body">
        <form id="provider-form">
          <input type="hidden" id="provider-id" name="provider-id">
          <input type="hidden" id="provider-mode" name="provider-mode" value="add">
          
          <div class="form-group">
            <label for="provider-name">Fournisseur</label>
            <select id="provider-name" name="provider-name" class="form-control" required>
              <option value="">Sélectionnez un fournisseur</option>
              <!-- Options générées dynamiquement -->
            </select>
          </div>
          
          <div class="form-group api-key-field">
            <label for="api-key">Clé API</label>
            <input type="password" id="api-key" name="api-key" class="form-control api-key-input">
            <button type="button" class="toggle-password" onclick="togglePasswordVisibility('api-key')">
              <i class="fas fa-eye"></i>
            </button>
            <div id="api-key-info" class="api-key-info hidden">
              <i class="fas fa-info-circle"></i>
              <span>Pour des raisons de sécurité, la clé API existante n'est pas affichée. Laissez ce champ vide pour conserver la clé actuelle ou saisissez une nouvelle clé pour la remplacer.</span>
            </div>
          </div>
          
          <div class="ai-form-row">
            <div class="ai-form-column">
              <div class="form-group">
                <label for="api-url">URL de l'API (facultatif)</label>
                <input type="url" id="api-url" name="api-url" class="form-control" placeholder="URL personnalisée de l'API">
                <small>Laissez vide pour utiliser l'URL par défaut du fournisseur.</small>
              </div>
            </div>
            <div class="ai-form-column">
              <div class="form-group">
                <label for="api-models">Modèles (séparés par des virgules)</label>
                <input type="text" id="api-models" name="api-models" class="form-control" placeholder="Modèles pris en charge">
                <small>Laissez vide pour utiliser les modèles par défaut du fournisseur.</small>
              </div>
            </div>
          </div>
          
          <div class="form-group">
            <label>Statut</label>
            <div class="radio-group">
              <div class="radio-option">
                <input type="radio" id="status-active" name="status" value="active" checked>
                <label for="status-active">Actif</label>
              </div>
              <div class="radio-option">
                <input type="radio" id="status-inactive" name="status" value="inactive">
                <label for="status-inactive">Inactif</label>
              </div>
            </div>
          </div>
          
          <div class="form-group">
            <label for="settings">Paramètres avancés (JSON)</label>
            <textarea id="settings" name="settings" class="form-control" rows="4" placeholder="{}">{}</textarea>
          </div>
          
          <div class="form-group">
            <button type="button" class="btn btn-primary" id="test-connection-button" onclick="testConnection()">
              <i class="fas fa-vial"></i> Tester la connexion
            </button>
          </div>
          
          <div id="test-result" class="hidden"></div>
          
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeModal('provider-modal')">Annuler</button>
            <button type="submit" class="btn btn-primary">Enregistrer</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <footer class="footer">
    <div class="container">
      <div class="footer-text">
        &copy; 2025 FHIRHub - Conversion HL7 v2.5 vers FHIR R4
      </div>
      <ul class="footer-links">
        <li><a href="/documentation.html">Documentation</a></li>
        <li><a href="/api-docs/">API</a></li>
      </ul>
    </div>
  </footer>

  <script>
    // Vérifier si l'utilisateur est admin avant d'afficher la page
    document.addEventListener('DOMContentLoaded', function() {
      FHIRHubAuth.checkUserRole(['admin'], '/dashboard.html');
      loadProviders();
    });
    
    // Variables globales
    let supportedProviders = [];
    let currentProviders = [];
    
    // Charger les fournisseurs d'IA depuis l'API
    async function loadProviders() {
      try {
        const headers = {
          'Authorization': `Bearer ${FHIRHubAuth.getAuthToken()}`
        };
        
        // Ajouter également la clé API par défaut pour l'authentification combinée
        if (localStorage.getItem('devKey')) {
          headers['X-API-KEY'] = localStorage.getItem('devKey');
        } else {
          headers['X-API-KEY'] = 'dev-key'; // Clé API de développement par défaut
        }

        const response = await fetch('/api/ai-providers', { headers });
        
        if (!response.ok) {
          throw new Error(`Erreur ${response.status}: ${response.statusText}`);
        }
        
        const providers = await response.json();
        currentProviders = providers;
        
        // Charger aussi la liste des fournisseurs pris en charge
        await loadSupportedProviders();
        
        // Afficher les fournisseurs
        displayProviders(providers);
      } catch (error) {
        console.error('Erreur lors du chargement des fournisseurs d\'IA:', error);
        document.getElementById('api-list').innerHTML = `
          <div class="alert alert-danger">
            Erreur lors du chargement des fournisseurs d'IA: ${error.message}
          </div>
        `;
      }
    }
    
    // Charger la liste des fournisseurs pris en charge
    async function loadSupportedProviders() {
      try {
        const headers = {
          'Authorization': `Bearer ${FHIRHubAuth.getAuthToken()}`
        };
        
        // Ajouter également la clé API par défaut pour l'authentification combinée
        if (localStorage.getItem('devKey')) {
          headers['X-API-KEY'] = localStorage.getItem('devKey');
        } else {
          headers['X-API-KEY'] = 'dev-key'; // Clé API de développement par défaut
        }

        const response = await fetch('/api/ai-providers/supported', { headers });
        
        if (!response.ok) {
          throw new Error(`Erreur ${response.status}: ${response.statusText}`);
        }
        
        supportedProviders = await response.json();
      } catch (error) {
        console.error('Erreur lors du chargement des fournisseurs pris en charge:', error);
      }
    }
    
    // Afficher les fournisseurs dans la liste
    function displayProviders(providers) {
      const apiList = document.getElementById('api-list');
      const noApis = document.getElementById('no-apis');
      const loadingSpinner = document.getElementById('loading-spinner');
      
      // Cacher le spinner s'il existe
      if (loadingSpinner) {
        loadingSpinner.classList.add('hidden');
      }
      
      // Vérifier s'il y a des fournisseurs à afficher
      if (providers.length === 0) {
        if (noApis) {
          noApis.classList.remove('hidden');
        }
        return;
      }
      
      // Cacher le message "aucune API"
      if (noApis) {
        noApis.classList.add('hidden');
      }
      
      // Générer le HTML pour chaque fournisseur
      const providersHtml = providers.map(provider => {
        const statusClass = provider.enabled === 1 ? 'ai-status-active' : 'ai-status-inactive';
        const statusText = provider.enabled === 1 ? 'Actif' : 'Inactif';
        
        return `
          <div class="ai-card" data-id="${provider.id}">
            <div class="ai-card-header">
              <h3>
                <i class="ai-provider-icon fas fa-robot"></i>
                ${provider.provider_name}
              </h3>
              <span class="ai-status ${statusClass}">${statusText}</span>
            </div>
            <div class="ai-card-body">
              <div class="ai-card-info">
                <span><i class="fas fa-link"></i> ${provider.api_url || 'URL par défaut'}</span>
                <span><i class="fas fa-code-branch"></i> ${provider.models || 'Modèles par défaut'}</span>
              </div>
              <div class="ai-card-info">
                <span><i class="fas fa-calendar-alt"></i> Ajouté le ${new Date(provider.created_at).toLocaleDateString()}</span>
                <span><i class="fas fa-clock"></i> Dernière mise à jour: ${new Date(provider.updated_at).toLocaleDateString()}</span>
              </div>
              <div class="actions" style="margin-top: 1rem;">
                <button class="btn btn-secondary" onclick="editProvider(${provider.id})">
                  <i class="fas fa-edit"></i> Modifier
                </button>
                <button class="btn btn-secondary" onclick="testProvider(${provider.id})">
                  <i class="fas fa-vial"></i> Tester
                </button>
                <button class="btn btn-danger" onclick="deleteProvider(${provider.id})">
                  <i class="fas fa-trash"></i> Supprimer
                </button>
              </div>
              ${provider.test_result ? displayTestResult(provider.test_result) : ''}
            </div>
          </div>
        `;
      }).join('');
      
      apiList.innerHTML = providersHtml;
    }
    
    // Afficher le résultat d'un test de connexion
    function displayTestResult(testResult) {
      try {
        const result = typeof testResult === 'string' ? JSON.parse(testResult) : testResult;
        const resultClass = result.success ? 'test-success' : 'test-error';
        
        return `
          <div class="test-result ${resultClass}">
            <strong>${result.success ? 'Test réussi' : 'Échec du test'}</strong>: ${result.message}
            <div style="font-size: 0.8rem; margin-top: 0.5rem;">
              Testé le: ${new Date(result.timestamp).toLocaleString()}
            </div>
          </div>
        `;
      } catch (error) {
        return '';
      }
    }
    
    // Afficher la modal de sélection des fournisseurs
    function showProviderSelection() {
      const modal = document.getElementById('provider-selection-modal');
      const providerList = document.getElementById('provider-list');
      
      // Générer la liste des fournisseurs pris en charge
      if (supportedProviders.length > 0) {
        const providersHtml = supportedProviders.map(provider => {
          return `
            <div class="ai-provider-card" onclick="showAddProviderModal('${provider.id}')">
              <div class="ai-provider-logo">
                <i class="fas fa-${getProviderIcon(provider.id)}"></i>
              </div>
              <div class="ai-provider-title">${provider.name}</div>
              <div class="ai-provider-description">${provider.description}</div>
            </div>
          `;
        }).join('');
        
        providerList.innerHTML = providersHtml;
      } else {
        providerList.innerHTML = `
          <div class="alert alert-warning">
            Impossible de charger la liste des fournisseurs pris en charge.
          </div>
        `;
      }
      
      modal.style.display = 'block';
    }
    
    // Obtenir l'icône pour un fournisseur spécifique
    function getProviderIcon(providerId) {
      const icons = {
        'openai': 'comment',
        'google': 'comment-dots',
        'anthropic': 'brain',
        'mistral': 'wind',
        'deepseek': 'search',
        'ollama': 'server',
        'custom': 'cog'
      };
      
      return icons[providerId] || 'robot';
    }
    
    // Afficher la modal pour ajouter un fournisseur
    function showAddProviderModal(providerId) {
      const modal = document.getElementById('provider-modal');
      const modalTitle = document.getElementById('provider-modal-title');
      const form = document.getElementById('provider-form');
      const providerNameSelect = document.getElementById('provider-name');
      const providerModeInput = document.getElementById('provider-mode');
      const testResult = document.getElementById('test-result');
      const apiKeyInfo = document.getElementById('api-key-info');
      const apiKeyInput = document.getElementById('api-key');
      
      // Fermer la modal de sélection
      closeModal('provider-selection-modal');
      
      // Réinitialiser le formulaire si le formulaire existe
      if (form) {
        form.reset();
      }
      
      // Cacher et vider le résultat du test s'il existe
      if (testResult) {
        testResult.classList.add('hidden');
        testResult.innerHTML = '';
      }
      
      // Cacher le message d'information sur la clé API pour un nouveau fournisseur
      if (apiKeyInfo) {
        apiKeyInfo.classList.add('hidden');
      }
      
      // Pour un nouveau fournisseur, la clé API est obligatoire
      if (apiKeyInput) {
        apiKeyInput.setAttribute('required', 'required');
      }
      
      // Définir le mode
      providerModeInput.value = 'add';
      modalTitle.textContent = 'Ajouter une nouvelle API d\'IA';
      
      // Remplir le select avec les fournisseurs pris en charge
      if (supportedProviders.length > 0) {
        providerNameSelect.innerHTML = `<option value="">Sélectionnez un fournisseur</option>`;
        
        supportedProviders.forEach(provider => {
          providerNameSelect.innerHTML += `
            <option value="${provider.id}" ${provider.id === providerId ? 'selected' : ''}>
              ${provider.name} - ${provider.description}
            </option>
          `;
        });
      }
      
      // Si un fournisseur spécifique a été sélectionné, pré-remplir les champs
      if (providerId) {
        const provider = supportedProviders.find(p => p.id === providerId);
        if (provider) {
          document.getElementById('api-url').value = provider.baseUrl || '';
          document.getElementById('api-models').value = provider.defaultModels || '';
        }
      }
      
      // Afficher la modal
      modal.style.display = 'block';
      
      // Configuration du formulaire
      form.onsubmit = function(e) {
        e.preventDefault();
        saveProvider();
      };
    }
    
    // Éditer un fournisseur existant
    async function editProvider(providerId) {
      try {
        const headers = {
          'Authorization': `Bearer ${FHIRHubAuth.getAuthToken()}`
        };
        
        // Ajouter également la clé API par défaut pour l'authentification combinée
        if (localStorage.getItem('devKey')) {
          headers['X-API-KEY'] = localStorage.getItem('devKey');
        } else {
          headers['X-API-KEY'] = 'dev-key'; // Clé API de développement par défaut
        }

        const response = await fetch(`/api/ai-providers/${providerId}`, { headers });
        
        if (!response.ok) {
          throw new Error(`Erreur ${response.status}: ${response.statusText}`);
        }
        
        const provider = await response.json();
        
        // Afficher la modal d'édition
        const modal = document.getElementById('provider-modal');
        const modalTitle = document.getElementById('provider-modal-title');
        const form = document.getElementById('provider-form');
        const providerIdInput = document.getElementById('provider-id');
        const providerModeInput = document.getElementById('provider-mode');
        const providerNameSelect = document.getElementById('provider-name');
        const testResult = document.getElementById('test-result');
        const apiKeyInfo = document.getElementById('api-key-info');
        const apiKeyInput = document.getElementById('api-key');
        
        // Réinitialiser le formulaire si le formulaire existe
        if (form) {
          form.reset();
        }
        
        // Cacher et vider le résultat du test s'il existe
        if (testResult) {
          testResult.classList.add('hidden');
          testResult.innerHTML = '';
        }
        
        // Définir le mode et l'ID
        providerModeInput.value = 'edit';
        providerIdInput.value = provider.id;
        modalTitle.textContent = `Modifier l'API ${provider.provider_name}`;
        
        // Remplir le select avec les fournisseurs pris en charge
        if (supportedProviders.length > 0) {
          providerNameSelect.innerHTML = `<option value="">Sélectionnez un fournisseur</option>`;
          
          supportedProviders.forEach(p => {
            providerNameSelect.innerHTML += `
              <option value="${p.id}" ${p.id === provider.provider_name || p.name === provider.provider_name ? 'selected' : ''}>
                ${p.name} - ${p.description}
              </option>
            `;
          });
        }
        
        // Remplir les champs avec les données du fournisseur
        document.getElementById('api-url').value = provider.api_url || '';
        document.getElementById('api-models').value = provider.models || '';
        
        // Sélectionner le statut
        if (provider.enabled === 1) {
          document.getElementById('status-active').checked = true;
        } else {
          document.getElementById('status-inactive').checked = true;
        }
        
        // Paramètres JSON
        const settings = provider.settings || '{}';
        document.getElementById('settings').value = typeof settings === 'string' ? settings : JSON.stringify(settings, null, 2);
        
        // Afficher le résultat du test s'il existe
        if (provider.test_result) {
          testResult.innerHTML = displayTestResult(provider.test_result);
          testResult.classList.remove('hidden');
        }
        
        // Afficher le message d'information sur la clé API pour un fournisseur existant
        if (apiKeyInfo) {
          apiKeyInfo.classList.remove('hidden');
        }
        
        // En mode édition, la clé API n'est pas obligatoire
        if (apiKeyInput) {
          apiKeyInput.removeAttribute('required');
        }
        
        // Afficher la modal
        modal.style.display = 'block';
        
        // Configuration du formulaire
        form.onsubmit = function(e) {
          e.preventDefault();
          saveProvider();
        };
      } catch (error) {
        console.error(`Erreur lors du chargement du fournisseur ${providerId}:`, error);
        showNotification('error', `Erreur lors du chargement du fournisseur: ${error.message}`);
      }
    }
    
    // Enregistrer un fournisseur (ajout ou modification)
    async function saveProvider() {
      try {
        const form = document.getElementById('provider-form');
        const mode = document.getElementById('provider-mode').value;
        const providerId = document.getElementById('provider-id').value;
        
        // Récupérer les données du formulaire
        const providerData = {
          provider_name: document.getElementById('provider-name').value,
          api_key: document.getElementById('api-key').value,
          api_url: document.getElementById('api-url').value,
          models: document.getElementById('api-models').value,
          enabled: document.querySelector('input[name="status"]:checked').value === 'active' ? 1 : 0,
          settings: document.getElementById('settings').value
        };
        
        // Valider les données
        if (!providerData.provider_name) {
          showNotification('error', 'Veuillez sélectionner un fournisseur.');
          return;
        }
        
        if (!providerData.api_key && mode === 'add') {
          showNotification('error', 'La clé API est obligatoire.');
          return;
        }
        
        // Valider le JSON des paramètres
        try {
          JSON.parse(providerData.settings);
        } catch (e) {
          showNotification('error', 'Les paramètres avancés doivent être au format JSON valide.');
          return;
        }
        
        // Définir la méthode et l'URL selon le mode
        let method = 'POST';
        let url = '/api/ai-providers';
        
        if (mode === 'edit') {
          method = 'PUT';
          url = `/api/ai-providers/${providerId}`;
          
          // Si la clé API est vide en mode édition, ne pas l'envoyer
          if (!providerData.api_key) {
            delete providerData.api_key;
          }
        }
        
        // Préparer les en-têtes avec authentification combinée
        const headers = {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${FHIRHubAuth.getAuthToken()}`
        };
        
        // Ajouter également la clé API par défaut pour l'authentification combinée
        if (localStorage.getItem('devKey')) {
          headers['X-API-KEY'] = localStorage.getItem('devKey');
        } else {
          headers['X-API-KEY'] = 'dev-key'; // Clé API de développement par défaut
        }
        
        // Envoyer les données à l'API
        const response = await fetch(url, {
          method: method,
          headers,
          body: JSON.stringify(providerData)
        });
        
        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error || `Erreur ${response.status}: ${response.statusText}`);
        }
        
        // Recharger la liste des fournisseurs
        await loadProviders();
        
        // Fermer la modal
        closeModal('provider-modal');
        
        // Afficher une notification de succès
        showNotification('success', `Fournisseur d'IA ${mode === 'add' ? 'ajouté' : 'mis à jour'} avec succès.`);
      } catch (error) {
        console.error('Erreur lors de l\'enregistrement du fournisseur:', error);
        showNotification('error', `Erreur lors de l'enregistrement du fournisseur: ${error.message}`);
      }
    }
    
    // Tester la connexion à un fournisseur
    async function testConnection() {
      try {
        const testButton = document.getElementById('test-connection-button');
        const testResult = document.getElementById('test-result');
        const mode = document.getElementById('provider-mode').value;
        const providerId = document.getElementById('provider-id').value;
        
        // Désactiver le bouton pendant le test
        testButton.disabled = true;
        testButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Test en cours...';
        
        // Si c'est un nouveau fournisseur, on ne peut pas tester
        if (mode === 'add') {
          showNotification('info', 'Veuillez d\'abord enregistrer le fournisseur pour pouvoir tester la connexion.');
          testButton.disabled = false;
          testButton.innerHTML = '<i class="fas fa-vial"></i> Tester la connexion';
          return;
        }
        
        // Préparer les en-têtes avec authentification combinée
        const headers = {
          'Authorization': `Bearer ${FHIRHubAuth.getAuthToken()}`
        };
        
        // Ajouter également la clé API par défaut pour l'authentification combinée
        if (localStorage.getItem('devKey')) {
          headers['X-API-KEY'] = localStorage.getItem('devKey');
        } else {
          headers['X-API-KEY'] = 'dev-key'; // Clé API de développement par défaut
        }

        // Envoyer la requête de test
        const response = await fetch(`/api/ai-providers/${providerId}/test`, {
          method: 'POST',
          headers
        });
        
        // Réactiver le bouton
        testButton.disabled = false;
        testButton.innerHTML = '<i class="fas fa-vial"></i> Tester la connexion';
        
        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error || `Erreur ${response.status}: ${response.statusText}`);
        }
        
        const result = await response.json();
        
        // Afficher le résultat du test si l'élément existe
        if (testResult) {
          testResult.innerHTML = displayTestResult(result);
          testResult.classList.remove('hidden');
        }
        
        // Afficher une notification
        if (result.success) {
          showNotification('success', 'Test de connexion réussi!');
        } else {
          showNotification('error', `Échec du test de connexion: ${result.message}`);
        }
      } catch (error) {
        console.error('Erreur lors du test de connexion:', error);
        document.getElementById('test-connection-button').disabled = false;
        document.getElementById('test-connection-button').innerHTML = '<i class="fas fa-vial"></i> Tester la connexion';
        
        // Afficher l'erreur si l'élément existe
        const testResult = document.getElementById('test-result');
        if (testResult) {
          testResult.innerHTML = `
            <div class="test-result test-error">
              <strong>Échec du test</strong>: ${error.message}
              <div style="font-size: 0.8rem; margin-top: 0.5rem;">
                Testé le: ${new Date().toLocaleString()}
              </div>
            </div>
          `;
          testResult.classList.remove('hidden');
        }
        
        showNotification('error', `Erreur lors du test de connexion: ${error.message}`);
      }
    }
    
    // Tester un fournisseur existant
    async function testProvider(providerId) {
      try {
        const headers = {
          'Authorization': `Bearer ${FHIRHubAuth.getAuthToken()}`
        };
        
        // Ajouter également la clé API par défaut pour l'authentification combinée
        if (localStorage.getItem('devKey')) {
          headers['X-API-KEY'] = localStorage.getItem('devKey');
        } else {
          headers['X-API-KEY'] = 'dev-key'; // Clé API de développement par défaut
        }

        // Envoyer la requête de test
        const response = await fetch(`/api/ai-providers/${providerId}/test`, {
          method: 'POST',
          headers
        });
        
        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error || `Erreur ${response.status}: ${response.statusText}`);
        }
        
        const result = await response.json();
        
        // Recharger la liste des fournisseurs pour afficher le résultat du test
        await loadProviders();
        
        // Afficher une notification
        if (result.success) {
          showNotification('success', 'Test de connexion réussi!');
        } else {
          showNotification('error', `Échec du test de connexion: ${result.message}`);
        }
      } catch (error) {
        console.error('Erreur lors du test de connexion:', error);
        showNotification('error', `Erreur lors du test de connexion: ${error.message}`);
      }
    }
    
    // Supprimer un fournisseur
    async function deleteProvider(providerId) {
      if (!confirm('Êtes-vous sûr de vouloir supprimer ce fournisseur d\'IA?')) {
        return;
      }
      
      try {
        const response = await fetch(`/api/ai-providers/${providerId}`, {
          method: 'DELETE',
          headers: {
            'Authorization': `Bearer ${FHIRHubAuth.getAuthToken()}`
          }
        });
        
        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error || `Erreur ${response.status}: ${response.statusText}`);
        }
        
        // Recharger la liste des fournisseurs
        await loadProviders();
        
        // Afficher une notification de succès
        showNotification('success', 'Fournisseur d\'IA supprimé avec succès.');
      } catch (error) {
        console.error('Erreur lors de la suppression du fournisseur:', error);
        showNotification('error', `Erreur lors de la suppression du fournisseur: ${error.message}`);
      }
    }
    
    // Fermer une modal
    function closeModal(modalId) {
      const modal = document.getElementById(modalId);
      if (modal) {
        modal.style.display = 'none';
      }
    }
    
    // Montrer/cacher le mot de passe
    function togglePasswordVisibility(inputId) {
      const input = document.getElementById(inputId);
      const icon = input.nextElementSibling.querySelector('i');
      
      if (input.type === 'password') {
        input.type = 'text';
        icon.className = 'fas fa-eye-slash';
      } else {
        input.type = 'password';
        icon.className = 'fas fa-eye';
      }
    }
    
    // Afficher une notification
    function showNotification(type, message) {
      // Créer l'élément de notification
      const notification = document.createElement('div');
      notification.className = `notification ${type}`;
      notification.innerHTML = message;
      
      // Ajouter la notification au DOM
      document.body.appendChild(notification);
      
      // Référence pour garder une trace si la notification existe encore
      let notificationExists = true;
      
      // Afficher la notification avec une animation
      setTimeout(() => {
        if (notification && notification.parentNode) {
          notification.classList.add('show');
        }
      }, 10);
      
      // Cacher la notification après un délai
      setTimeout(() => {
        if (notification && notification.parentNode) {
          try {
            notification.classList.remove('show');
            
            // Supprimer la notification du DOM après l'animation
            setTimeout(() => {
              if (notification && notification.parentNode) {
                try {
                  document.body.removeChild(notification);
                  notificationExists = false;
                } catch (err) {
                  console.log('Notification déjà supprimée');
                }
              }
            }, 300);
          } catch (err) {
            console.log('Erreur lors de la suppression de classe:', err);
            // Tenter de supprimer directement la notification
            if (notification && notification.parentNode) {
              try {
                document.body.removeChild(notification);
                notificationExists = false;
              } catch (err) {
                console.log('Notification déjà supprimée');
              }
            }
          }
        }
      }, 3000);
    }
    
    // Fermer les modals quand on clique sur la croix
    document.querySelectorAll('.close').forEach(closeBtn => {
      closeBtn.addEventListener('click', function() {
        this.closest('.modal').style.display = 'none';
      });
    });
    
    // Fermer les modals quand on clique en dehors
    window.addEventListener('click', function(event) {
      document.querySelectorAll('.modal').forEach(modal => {
        if (event.target === modal) {
          modal.style.display = 'none';
        }
      });
    });
  </script>

  <style>
    /* Styles pour les notifications */
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 20px;
      border-radius: 4px;
      color: white;
      font-weight: bold;
      max-width: 300px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      transform: translateX(120%);
      transition: transform 0.3s ease;
      z-index: 10000;
    }
    
    .notification.show {
      transform: translateX(0);
    }
    
    .notification.success {
      background-color: #2ecc71;
    }
    
    .notification.error {
      background-color: #e74c3c;
    }
    
    .notification.info {
      background-color: #3498db;
    }
    
    .notification.warning {
      background-color: #f39c12;
    }
    
    /* Styles pour les modals */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0, 0, 0, 0.5);
    }
    
    .modal-content {
      background-color: white;
      margin: 10% auto;
      padding: 20px;
      border-radius: 5px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
      width: 80%;
      max-width: 600px;
      animation: modalFadeIn 0.3s;
    }
    
    .large-modal {
      max-width: 800px;
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 1px solid var(--border-color);
    }
    
    .modal-header h3 {
      margin: 0;
      color: var(--primary-color);
    }
    
    .modal-footer {
      margin-top: 20px;
      padding-top: 10px;
      border-top: 1px solid var(--border-color);
      display: flex;
      justify-content: flex-end;
    }
    
    .modal-footer button {
      margin-left: 10px;
    }
    
    .close {
      color: #aaa;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }
    
    .close:hover {
      color: black;
    }
    
    @keyframes modalFadeIn {
      from {
        opacity: 0;
        transform: translateY(-50px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    /* Styles pour le spinner de chargement */
    .loading-spinner {
      text-align: center;
      padding: 20px;
      font-size: 1.2rem;
      color: #777;
    }
    
    .loading-spinner i {
      margin-right: 10px;
      color: var(--primary-color);
    }
    
    /* Styles généraux */
    .hidden {
      display: none;
    }
    
    /* Styles pour l'information sur la clé API */
    .api-key-info {
      margin-top: 8px;
      padding: 8px 12px;
      background: #f8f9fa;
      border-radius: 4px;
      color: #666;
      font-size: 0.9em;
      display: flex;
      align-items: flex-start;
    }
    
    .api-key-info i {
      margin-right: 8px;
      margin-top: 3px;
      color: #3498db;
    }
  </style>
</body>
</html>