<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Paramètres - FHIRHub</title>
  <link rel="stylesheet" href="/css/styles.css">
  <link rel="stylesheet" href="/css/support-chatbot.css">
  <link rel="stylesheet" href="/css/admin.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
  <style>
    .settings-container {
      max-width: 1200px;
      margin: 0 auto;
    }

    .tab-container {
      margin-bottom: 1rem;
    }

    .tab-buttons {
      display: flex;
      list-style: none;
      padding: 0;
      margin: 0;
      border-bottom: 2px solid #ddd;
    }

    .tab-buttons li {
      padding: 1rem 1.5rem;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.3s ease;
      margin-right: 0.5rem;
      border-radius: 4px 4px 0 0;
      position: relative;
    }

    .tab-buttons li.active {
      color: #e74c3c;
      background: linear-gradient(135deg, rgba(231, 76, 60, 0.1), rgba(231, 76, 60, 0.05));
      border-bottom: 3px solid #e74c3c;
      font-weight: 600;
    }

    .tab-buttons li:hover:not(.active) {
      background-color: #f5f5f5;
    }

    .tab-buttons li i {
      margin-right: 8px;
    }

    .tab-content {
      margin-top: 20px;
    }

    .tab-pane {
      display: none;
      animation: fadeIn 0.5s;
    }

    .tab-pane.active {
      display: block;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .iframe-container {
      width: 100%;
      height: calc(100vh - 250px); /* Ajustement de la hauteur pour éviter les doubles scrollbars */
      overflow: hidden;
      border: none;
      position: relative;
      background-color: #fff;
      border-radius: 0 0 8px 8px;
    }

    iframe {
      width: 100%;
      height: 100%;
      border: none;
      margin-top: -115px; /* Masque l'en-tête des pages */
      overflow: hidden; /* Empêche le défilement interne de l'iframe */
    }

    .loading-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(255, 255, 255, 0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 5;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid #e74c3c;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }

    .section-header h2 {
      margin: 0;
    }

    .section-buttons {
      display: flex;
      gap: 0.5rem;
    }
  </style>
</head>
<body>
  <header class="header">
    <div class="container">
      <div class="logo">
        <img src="/img/flame-icon-white.svg" alt="FHIRHub Logo">
        <span>FHIRHub</span>
      </div>
      
      <ul class="nav-menu">
        <li><a href="/dashboard.html"><i class="fas fa-chart-line"></i> Tableau de bord</a></li>
        <li><a href="/convert.html"><i class="fas fa-exchange-alt"></i> Conversion</a></li>
        <li><a href="/workflows.html"><i class="fas fa-project-diagram"></i> Workflows</a></li>
        <li><a href="/settings.html" class="active"><i class="fas fa-cog"></i> Paramètres</a></li>
        <li><a href="/documentation.html"><i class="fas fa-file-alt"></i> Documentation</a></li>
        <li><a href="/api-docs/"><i class="fas fa-code"></i> API</a></li>
        <li><a href="#" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Déconnexion</a></li>
      </ul>
    </div>
  </header>

  <div class="main-content">
    <div class="container settings-container">
      <h1>Paramètres</h1>
      
      <div class="tab-container">
        <ul class="tab-buttons" id="settings-tabs">
          <li data-tab="users" class="active"><i class="fas fa-users"></i> Utilisateurs</li>
          <li data-tab="applications"><i class="fas fa-th"></i> Applications</li>
          <li data-tab="terminologies"><i class="fas fa-book-medical"></i> Terminologies</li>
          <li data-tab="ai-settings"><i class="fas fa-robot"></i> Paramètres IA</li>
        </ul>
        
        <div class="tab-content">
          <!-- Onglet Utilisateurs -->
          <div class="tab-pane active" id="users-tab">
            <div class="section-header">
              <h2>Gestion des Utilisateurs</h2>
              <div class="section-buttons">
                <button id="add-user-btn" class="btn btn-primary"><i class="fas fa-user-plus"></i> Nouvel utilisateur</button>
              </div>
            </div>
            
            <div class="card">
              <div class="card-header">
                <h2 class="card-title">Liste des utilisateurs</h2>
              </div>
              
              <div class="table-responsive">
                <table class="table">
                  <thead>
                    <tr>
                      <th>ID</th>
                      <th>Nom d'utilisateur</th>
                      <th>Rôle</th>
                      <th>Date de création</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody id="usersList">
                    <!-- Les utilisateurs seront chargés ici dynamiquement -->
                  </tbody>
                </table>
              </div>
            </div>
          </div>
          
          <!-- Onglet Applications -->
          <div class="tab-pane" id="applications-tab">
            <div class="section-header">
              <h2>Gestion des Applications</h2>
              <div class="section-buttons">
                <button id="add-application-btn" class="btn btn-primary"><i class="fas fa-plus"></i> Nouvelle application</button>
              </div>
            </div>
            
            <!-- Applications -->
            <div class="card">
              <div class="card-header">
                <h2 class="card-title">Applications</h2>
              </div>
              <div class="card-body">
                <div class="table-responsive">
                  <table class="table">
                    <thead>
                      <tr>
                        <th>Nom</th>
                        <th>Description</th>
                        <th>Date de création</th>
                        <th>API Keys</th>
                        <th>Actions</th>
                      </tr>
                    </thead>
                    <tbody id="applicationsList">
                      <!-- Les applications seront chargées ici dynamiquement -->
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
            
            <!-- Clés API -->
            <div class="card mt-4">
              <div class="card-header">
                <h2 class="card-title">Clés API</h2>
              </div>
              <div class="card-body">
                <div class="table-responsive">
                  <table class="table">
                    <thead>
                      <tr>
                        <th>Application</th>
                        <th>Clé</th>
                        <th>Description</th>
                        <th>Date de création</th>
                        <th>Statut</th>
                        <th>Actions</th>
                      </tr>
                    </thead>
                    <tbody id="apiKeysList">
                      <!-- Les clés API seront chargées ici dynamiquement -->
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Onglet Terminologies -->
          <div class="tab-pane" id="terminologies-tab">
            <div class="section-header">
              <h2>Gestion des Terminologies</h2>
              <div class="section-buttons">
                <button id="refresh-terminology-btn" class="btn btn-secondary"><i class="fas fa-sync-alt"></i> Rafraîchir</button>
                <button id="import-terminology-btn" class="btn btn-primary"><i class="fas fa-file-import"></i> Importer</button>
              </div>
            </div>
            
            <!-- Statistiques des terminologies -->
            <div class="stats-container">
              <div class="stat-card">
                <div class="stat-icon">
                  <i class="fas fa-code-branch"></i>
                </div>
                <div class="stat-info">
                  <h3>Version</h3>
                  <p id="terminology-version">Chargement...</p>
                </div>
              </div>
              <div class="stat-card">
                <div class="stat-icon">
                  <i class="fas fa-calendar-alt"></i>
                </div>
                <div class="stat-info">
                  <h3>Dernière mise à jour</h3>
                  <p id="terminology-last-updated">Chargement...</p>
                </div>
              </div>
              <div class="stat-card">
                <div class="stat-icon">
                  <i class="fas fa-file-alt"></i>
                </div>
                <div class="stat-info">
                  <h3>Fichiers</h3>
                  <p id="terminology-files-count">Chargement...</p>
                </div>
              </div>
              <div class="stat-card">
                <div class="stat-icon">
                  <i class="fas fa-sitemap"></i>
                </div>
                <div class="stat-info">
                  <h3>Systèmes</h3>
                  <p id="terminology-systems-count">Chargement...</p>
                </div>
              </div>
              <div class="stat-card">
                <div class="stat-icon">
                  <i class="fas fa-tags"></i>
                </div>
                <div class="stat-info">
                  <h3>OIDs</h3>
                  <p id="terminology-oids-count">Chargement...</p>
                </div>
              </div>
            </div>
            
            <!-- Liste des fichiers de terminologie -->
            <div class="card-container">
              <div class="card">
                <div class="card-header">
                  <h2>Référentiels et Nomenclatures ANS</h2>
                  <button id="refresh-terminology-files" class="btn btn-icon">
                    <i class="fas fa-sync-alt"></i>
                  </button>
                </div>
                <div class="card-body">
                  <table class="data-table">
                    <thead>
                      <tr>
                        <th>Nom du fichier</th>
                        <th>Type</th>
                        <th>Description</th>
                        <th>Dernière mise à jour</th>
                        <th>Contenus</th>
                        <th>Actions</th>
                      </tr>
                    </thead>
                    <tbody id="terminology-files-table">
                      <tr>
                        <td colspan="6" class="loading-row">Chargement des fichiers...</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
            
            <!-- Zone de logs des mises à jour -->
            <div class="card-container">
              <div class="card">
                <div class="card-header">
                  <h2>Journal des mises à jour des Nomenclatures</h2>
                  <button id="clear-logs" class="btn btn-icon">
                    <i class="fas fa-trash"></i>
                  </button>
                </div>
                <div class="card-body">
                  <div class="log-container" id="update-logs">
                    <div class="log-empty">Aucun log de mise à jour disponible</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Onglet Paramètres IA -->
          <div class="tab-pane" id="ai-settings-tab">
            <div class="section-header">
              <h2>Paramètres IA</h2>
              <div class="section-buttons">
                <button id="test-ai-btn" class="btn btn-secondary"><i class="fas fa-vial"></i> Tester</button>
                <button id="add-ai-provider-btn" class="btn btn-primary"><i class="fas fa-plus"></i> Ajouter un fournisseur</button>
              </div>
            </div>
            
            <!-- Liste des APIs d'IA configurées -->
            <div class="card">
              <div class="card-header">
                <h2 class="card-title">APIs d'Intelligence Artificielle</h2>
              </div>
              <div class="card-body">
                <p>
                  Gérez vos connexions aux API d'IA pour améliorer les fonctionnalités de FHIRHub. 
                  Les API configurées peuvent être utilisées pour l'assistance utilisateur et les fonctionnalités de support.
                </p>
                
                <div id="api-list" class="api-list">
                  <div class="loading-spinner" id="loading-spinner">
                    <i class="fas fa-spinner fa-spin"></i> Chargement des API d'IA...
                  </div>
                  <div id="no-apis" class="alert alert-info hidden">
                    Aucune API d'IA configurée. Ajoutez une nouvelle API pour commencer.
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modaux Utilisateurs -->
  <div class="modal" id="createUserModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Créer un nouvel utilisateur</h2>
        <span class="close">&times;</span>
      </div>
      <div class="modal-body">
        <form id="createUserForm">
          <div class="form-group">
            <label for="username">Nom d'utilisateur</label>
            <input type="text" id="username" name="username" class="form-control" required>
          </div>
          
          <div class="form-group">
            <label for="password">Mot de passe</label>
            <input type="password" id="password" name="password" class="form-control" required>
          </div>
          
          <div class="form-group">
            <label for="role">Rôle</label>
            <select id="role" name="role" class="form-control" required>
              <option value="admin">Administrateur</option>
              <option value="user">Utilisateur</option>
            </select>
          </div>
          
          <div class="form-actions">
            <button type="submit" class="btn btn-primary">Créer</button>
            <button type="button" class="btn btn-secondary" id="cancelCreateUser">Annuler</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <div class="modal" id="deleteUserModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Confirmer la suppression</h2>
        <span class="close">&times;</span>
      </div>
      <div class="modal-body">
        <p>Êtes-vous sûr de vouloir supprimer cet utilisateur ?</p>
        <input type="hidden" id="deleteUserId">
        
        <div class="form-actions">
          <button type="button" class="btn btn-danger" id="confirmDeleteUser">Supprimer</button>
          <button type="button" class="btn btn-secondary" id="cancelDeleteUser">Annuler</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal" id="editUserModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Modifier l'utilisateur</h2>
        <span class="close">&times;</span>
      </div>
      <div class="modal-body">
        <form id="editUserForm">
          <input type="hidden" id="editUserId">
          
          <div class="form-group">
            <label for="editUsername">Nom d'utilisateur</label>
            <input type="text" id="editUsername" name="editUsername" class="form-control" required>
          </div>
          
          <div class="form-group">
            <label for="editPassword">Nouveau mot de passe (laisser vide pour ne pas changer)</label>
            <input type="password" id="editPassword" name="editPassword" class="form-control">
          </div>
          
          <div class="form-group">
            <label for="editRole">Rôle</label>
            <select id="editRole" name="editRole" class="form-control" required>
              <option value="admin">Administrateur</option>
              <option value="user">Utilisateur</option>
            </select>
          </div>
          
          <div class="form-actions">
            <button type="submit" class="btn btn-primary">Mettre à jour</button>
            <button type="button" class="btn btn-secondary" id="cancelEditUser">Annuler</button>
          </div>
        </form>
      </div>
    </div>
  </div>
  
  <!-- Modaux Applications -->
  <div class="modal" id="createAppModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Créer une nouvelle application</h2>
        <span class="close">&times;</span>
      </div>
      <div class="modal-body">
        <form id="createAppForm">
          <div class="form-group">
            <label for="appName">Nom de l'application</label>
            <input type="text" id="appName" name="appName" class="form-control" required>
          </div>
          
          <div class="form-group">
            <label for="appDescription">Description</label>
            <textarea id="appDescription" name="appDescription" class="form-control" rows="3"></textarea>
          </div>
          
          <div class="form-group">
            <label for="corsOrigins">Origines CORS (facultatif)</label>
            <input type="text" id="corsOrigins" name="corsOrigins" class="form-control" placeholder="http://example.com, https://app.example.com">
            <small class="form-text">Séparez les multiples origines par des virgules</small>
          </div>
          
          <div class="form-actions">
            <button type="submit" class="btn btn-primary">Créer</button>
            <button type="button" class="btn btn-secondary close-modal">Annuler</button>
          </div>
        </form>
      </div>
    </div>
  </div>
  
  <div class="modal" id="createKeyModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Créer une nouvelle clé API</h2>
        <span class="close">&times;</span>
      </div>
      <div class="modal-body">
        <form id="createKeyForm">
          <div class="form-group">
            <label for="keyApp">Application</label>
            <select id="keyApp" name="keyApp" class="form-control" required>
              <!-- Options générées dynamiquement -->
            </select>
          </div>
          
          <div class="form-group">
            <label for="keyDescription">Description</label>
            <input type="text" id="keyDescription" name="keyDescription" class="form-control" required>
          </div>
          
          <div class="form-actions">
            <button type="submit" class="btn btn-primary">Créer</button>
            <button type="button" class="btn btn-secondary close-modal">Annuler</button>
          </div>
        </form>
      </div>
    </div>
  </div>
  
  <div class="modal" id="newKeyModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Nouvelle clé API créée</h2>
        <span class="close">&times;</span>
      </div>
      <div class="modal-body">
        <div class="alert alert-warning">
          <i class="fas fa-exclamation-triangle"></i>
          <strong>Important</strong>: Copiez cette clé maintenant. Vous ne pourrez plus la voir ensuite.
        </div>
        
        <div class="form-group">
          <label for="newApiKey">Clé API</label>
          <div class="api-key-display">
            <pre id="newApiKey"></pre>
            <button type="button" class="btn btn-secondary btn-copy" id="copyKeyBtn">
              <i class="fas fa-copy"></i> Copier
            </button>
          </div>
        </div>
        
        <div class="form-actions">
          <button type="button" class="btn btn-primary close-modal">OK</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Modaux Terminologies -->
  <div class="modal" id="file-upload-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Importer des Nomenclatures Médicales ANS</h2>
        <button class="close-modal">&times;</button>
      </div>
      <div class="modal-body">
        <div class="dropzone-container" id="terminology-dropzone">
          <i class="fas fa-cloud-upload-alt dropzone-icon"></i>
          <h3 class="dropzone-title">Déposez vos fichiers JSON ici</h3>
          <p class="dropzone-desc">Importez des référentiels depuis l'API ANS pour les terminologies médicales françaises</p>
          <button class="dropzone-button" id="browse-terminology-files">Parcourir</button>
        </div>
        
        <div id="selected-files-container">
          <h3>Fichiers sélectionnés</h3>
          <div id="selected-files-list">
            <div class="file-list-empty" id="upload-empty-message">Aucun fichier sélectionné</div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary close-modal">Annuler</button>
        <button class="btn btn-primary" id="upload-selected-files">Importer les fichiers</button>
      </div>
    </div>
  </div>

  <div class="modal" id="file-preview-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="preview-filename">Aperçu du fichier</h2>
        <button class="close-modal">&times;</button>
      </div>
      <div class="modal-body">
        <pre id="file-preview-content" class="code-preview"></pre>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary close-modal">Fermer</button>
      </div>
    </div>
  </div>
  
  <!-- Modaux Paramètres IA -->
  <div class="modal" id="provider-selection-modal">
    <div class="modal-content large-modal">
      <div class="modal-header">
        <h3>Choisir un fournisseur d'IA</h3>
        <span class="close">&times;</span>
      </div>
      <div class="modal-body">
        <p>Sélectionnez un fournisseur d'IA pour configurer une nouvelle API :</p>
        <div class="ai-provider-list" id="provider-list">
          <!-- Liste des fournisseurs générée dynamiquement -->
          <div class="loading-spinner">
            <i class="fas fa-spinner fa-spin"></i> Chargement des fournisseurs...
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="modal" id="provider-modal">
    <div class="modal-content large-modal">
      <div class="modal-header">
        <h3 id="provider-modal-title">Configurer une API d'IA</h3>
        <span class="close">&times;</span>
      </div>
      <div class="modal-body">
        <form id="provider-form">
          <input type="hidden" id="provider-id" name="provider-id">
          <input type="hidden" id="provider-mode" name="provider-mode" value="add">
          
          <div class="form-group">
            <label for="provider-name">Fournisseur</label>
            <select id="provider-name" name="provider-name" class="form-control" required>
              <option value="">Sélectionnez un fournisseur</option>
              <!-- Options générées dynamiquement -->
            </select>
          </div>
          
          <div class="form-group api-key-field">
            <label for="api-key">Clé API</label>
            <input type="password" id="api-key" name="api-key" class="form-control api-key-input">
            <button type="button" class="toggle-password" onclick="togglePasswordVisibility('api-key')">
              <i class="fas fa-eye"></i>
            </button>
            <div id="api-key-info" class="api-key-info hidden">
              <i class="fas fa-info-circle"></i>
              <span>Pour des raisons de sécurité, la clé API existante n'est pas affichée. Laissez ce champ vide pour conserver la clé actuelle ou saisissez une nouvelle clé pour la remplacer.</span>
            </div>
          </div>
          
          <div class="ai-form-row">
            <div class="ai-form-column">
              <div class="form-group">
                <label for="api-url">URL de l'API (facultatif)</label>
                <input type="url" id="api-url" name="api-url" class="form-control" placeholder="URL personnalisée de l'API">
                <small>Laissez vide pour utiliser l'URL par défaut du fournisseur.</small>
              </div>
            </div>
            <div class="ai-form-column">
              <div class="form-group">
                <label for="api-models">Modèles (séparés par des virgules)</label>
                <input type="text" id="api-models" name="api-models" class="form-control" placeholder="Modèles pris en charge">
                <small>Laissez vide pour utiliser les modèles par défaut du fournisseur.</small>
              </div>
            </div>
          </div>
          
          <div class="form-group">
            <label>Statut</label>
            <div class="radio-group">
              <div class="radio-option">
                <input type="radio" id="status-active" name="status" value="active" checked>
                <label for="status-active">Actif</label>
              </div>
              <div class="radio-option">
                <input type="radio" id="status-inactive" name="status" value="inactive">
                <label for="status-inactive">Inactif</label>
              </div>
            </div>
          </div>
          
          <div class="form-group">
            <label for="settings">Paramètres avancés (JSON)</label>
            <textarea id="settings" name="settings" class="form-control" rows="4" placeholder="{}">{}</textarea>
          </div>
          
          <div class="form-group">
            <button type="button" class="btn btn-primary" id="test-connection-button" onclick="testConnection()">
              <i class="fas fa-vial"></i> Tester la connexion
            </button>
          </div>
          
          <div id="test-result" class="hidden"></div>
          
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeModal('provider-modal')">Annuler</button>
            <button type="submit" class="btn btn-primary">Enregistrer</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <footer class="footer">
    <div class="container">
      <div class="footer-text">
        &copy; 2025 FHIRHub - Service de conversion HL7 vers FHIR
      </div>
      <ul class="footer-links">
        <li><a href="/documentation.html">Documentation</a></li>
        <li><a href="/api-docs">API</a></li>
      </ul>
    </div>
  </footer>

  <script src="/js/auth-utils.js"></script>
  <script src="/js/support-chatbot.js"></script>
  
  <script src="/js/settings.js"></script>
  
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Vérifier l'authentification
      const token = localStorage.getItem('token');
      if (!token) {
        window.location.href = '/login.html';
        return;
      }
      
      // Gestion de la déconnexion
      document.getElementById('logoutBtn').addEventListener('click', function(e) {
        e.preventDefault();
        localStorage.removeItem('token');
        localStorage.removeItem('user');
        window.location.href = '/login.html';
      });
      
      // Gestion des onglets
      const tabButtons = document.querySelectorAll('#settings-tabs li');
      
      tabButtons.forEach(button => {
        button.addEventListener('click', function() {
          // Retirer la classe active de tous les onglets
          tabButtons.forEach(btn => btn.classList.remove('active'));
          
          // Ajouter la classe active à l'onglet cliqué
          this.classList.add('active');
          
          // Récupérer l'ID de l'onglet cible
          const tabId = this.getAttribute('data-tab') + '-tab';
          
          // Masquer tous les contenus d'onglets
          document.querySelectorAll('.tab-pane').forEach(pane => {
            pane.classList.remove('active');
          });
          
          // Afficher le contenu de l'onglet sélectionné
          document.getElementById(tabId).classList.add('active');
          
          // Charger le contenu de l'onglet si nécessaire
          if (tabId === 'users-tab' && !document.querySelector('#usersList tr')) {
            loadUsers();
          } else if (tabId === 'applications-tab' && !document.querySelector('#applicationsList tr')) {
            loadApplications();
            loadApiKeys();
          } else if (tabId === 'terminologies-tab' && document.querySelector('#terminology-files-table .loading-row')) {
            loadTerminologyFiles();
            loadTerminologyStats();
          } else if (tabId === 'ai-settings-tab' && document.querySelector('#api-list .loading-spinner')) {
            loadAIProviders();
          }
        });
      });
      
      // Initialiser les gestionnaires d'événements
      initializeUserEvents();
      initializeApplicationEvents();
      initializeTerminologyEvents();
      initializeAISettingsEvents();
      
      // Charger initialement les données de l'onglet actif
      const activeTab = document.querySelector('.tab-pane.active').id;
      if (activeTab === 'users-tab') {
        loadUsers();
      }
      
      // Fermeture des modaux
      document.querySelectorAll('.close, .close-modal, #cancelCreateUser, #cancelDeleteUser, #cancelEditUser').forEach(el => {
        el.addEventListener('click', function() {
          closeAllModals();
        });
      });
    });
    
    // Fonctions utilitaires
    function closeAllModals() {
      document.querySelectorAll('.modal').forEach(modal => {
        modal.style.display = 'none';
      });
    }
    
    function openModal(id) {
      const modal = document.getElementById(id);
      if (modal) {
        modal.style.display = 'flex';
      }
    }
    
    function showError(message) {
      alert('Erreur: ' + message);
    }
    
    function formatDate(dateString) {
      const date = new Date(dateString);
      return date.toLocaleDateString('fr-FR', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
    }
    
    // Fonction pour copier du texte dans le presse-papier
    function copyToClipboard(text) {
      const textarea = document.createElement('textarea');
      textarea.value = text;
      document.body.appendChild(textarea);
      textarea.select();
      document.execCommand('copy');
      document.body.removeChild(textarea);
    }
    
    // Fonction pour alterner la visibilité d'un champ password
    function togglePasswordVisibility(fieldId) {
      const field = document.getElementById(fieldId);
      const icon = document.querySelector(`button.toggle-password i`);
      
      if (field.type === 'password') {
        field.type = 'text';
        icon.classList.remove('fa-eye');
        icon.classList.add('fa-eye-slash');
      } else {
        field.type = 'password';
        icon.classList.remove('fa-eye-slash');
        icon.classList.add('fa-eye');
      }
    }
    
    // Création d'un gestionnaire fetch avec authentification
    async function fetchWithAuth(url, options = {}) {
      const token = localStorage.getItem('token');
      
      if (!token) {
        window.location.href = '/login.html';
        return;
      }
      
      const headers = {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json',
        ...(options.headers || {})
      };
      
      try {
        const response = await fetch(url, {
          ...options,
          headers
        });
        
        if (response.status === 401) {
          localStorage.removeItem('token');
          localStorage.removeItem('user');
          window.location.href = '/login.html';
          return;
        }
        
        if (!response.ok) {
          const error = await response.text();
          throw new Error(error || 'Une erreur est survenue');
        }
        
        if (response.status === 204) {
          return null;
        }
        
        return await response.json();
      } catch (error) {
        console.error('Erreur fetch:', error);
        throw error;
      }
    }
    
    // Gestion des utilisateurs
    function initializeUserEvents() {
      // Ouvrir le modal de création d'utilisateur
      document.getElementById('add-user-btn').addEventListener('click', function() {
        document.getElementById('createUserForm').reset();
        openModal('createUserModal');
      });
      
      // Créer un utilisateur
      document.getElementById('createUserForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const userData = {
          username: document.getElementById('username').value,
          password: document.getElementById('password').value,
          role: document.getElementById('role').value
        };
        
        try {
          await fetchWithAuth('/api/users', {
            method: 'POST',
            body: JSON.stringify(userData)
          });
          
          closeAllModals();
          loadUsers();
        } catch (error) {
          showError(error.message);
        }
      });
      
      // Confirmer la suppression
      document.getElementById('confirmDeleteUser').addEventListener('click', async function() {
        const userId = document.getElementById('deleteUserId').value;
        
        try {
          await fetchWithAuth(`/api/users/${userId}`, {
            method: 'DELETE'
          });
          
          closeAllModals();
          loadUsers();
        } catch (error) {
          showError(error.message);
        }
      });
      
      // Mettre à jour un utilisateur
      document.getElementById('editUserForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const userId = document.getElementById('editUserId').value;
        const userData = {
          username: document.getElementById('editUsername').value,
          role: document.getElementById('editRole').value
        };
        
        const password = document.getElementById('editPassword').value;
        if (password) {
          userData.password = password;
        }
        
        try {
          await fetchWithAuth(`/api/users/${userId}`, {
            method: 'PUT',
            body: JSON.stringify(userData)
          });
          
          closeAllModals();
          loadUsers();
        } catch (error) {
          showError(error.message);
        }
      });
    }
    
    async function loadUsers() {
      try {
        const usersList = document.getElementById('usersList');
        usersList.innerHTML = '<tr><td colspan="5" class="loading-row">Chargement des utilisateurs...</td></tr>';
        
        const response = await fetchWithAuth('/api/users');
        
        // Vérifier la structure de la réponse
        console.log('Users response:', response);
        
        // Ajout de vérification robuste pour éviter l'erreur "Cannot read properties of undefined (reading 'data')"
        if (!response) {
          throw new Error('Réponse vide ou invalide');
        }
        
        // Extraire les données depuis la réponse
        // La structure peut être soit {success: true, data: [...]} soit directement un tableau
        let users = [];
        
        if (response.success && Array.isArray(response.data)) {
          // Format {success: true, data: [...]}
          users = response.data;
        } else if (Array.isArray(response)) {
          // Format direct [...]
          users = response;
        } else if (response.data && Array.isArray(response.data)) {
          // Au cas où data existe mais success n'existe pas
          users = response.data;
        } else {
          console.error('Format de réponse non reconnu:', response);
          usersList.innerHTML = '<tr><td colspan="5" class="empty-row">Erreur lors du chargement des utilisateurs: format de données invalide</td></tr>';
          return;
        }
        
        // Si aucun utilisateur n'est trouvé
        if (users.length === 0) {
          usersList.innerHTML = '<tr><td colspan="5" class="empty-row">Aucun utilisateur trouvé</td></tr>';
          return;
        }
        
        usersList.innerHTML = '';
        users.forEach(user => {
          usersList.innerHTML += `
            <tr>
              <td>${user.id}</td>
              <td>${user.username}</td>
              <td><span class="badge ${user.role === 'admin' ? 'badge-admin' : 'badge-user'}">${user.role}</span></td>
              <td>${formatDate(user.created_at)}</td>
              <td>
                <button class="btn btn-icon edit-user" data-id="${user.id}" data-username="${user.username}" data-role="${user.role}">
                  <i class="fas fa-pencil-alt"></i>
                </button>
                <button class="btn btn-icon delete-user" data-id="${user.id}">
                  <i class="fas fa-trash"></i>
                </button>
              </td>
            </tr>
          `;
        });
        
        // Attacher les événements aux boutons
        document.querySelectorAll('.edit-user').forEach(button => {
          button.addEventListener('click', function() {
            const userId = this.getAttribute('data-id');
            const username = this.getAttribute('data-username');
            const role = this.getAttribute('data-role');
            
            document.getElementById('editUserId').value = userId;
            document.getElementById('editUsername').value = username;
            document.getElementById('editPassword').value = '';
            document.getElementById('editRole').value = role;
            
            openModal('editUserModal');
          });
        });
        
        document.querySelectorAll('.delete-user').forEach(button => {
          button.addEventListener('click', function() {
            const userId = this.getAttribute('data-id');
            document.getElementById('deleteUserId').value = userId;
            openModal('deleteUserModal');
          });
        });
      } catch (error) {
        showError('Erreur lors du chargement des utilisateurs: ' + error.message);
      }
    }
    
    // Gestion des applications et clés API
    function initializeApplicationEvents() {
      // Ouvrir le modal de création d'application
      document.getElementById('add-application-btn').addEventListener('click', function() {
        document.getElementById('createAppForm').reset();
        openModal('createAppModal');
      });
      
      // Créer une application
      document.getElementById('createAppForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const appData = {
          name: document.getElementById('appName').value,
          description: document.getElementById('appDescription').value,
          cors_origins: document.getElementById('corsOrigins').value
        };
        
        try {
          await fetchWithAuth('/api/applications', {
            method: 'POST',
            body: JSON.stringify(appData)
          });
          
          closeAllModals();
          loadApplications();
        } catch (error) {
          showError(error.message);
        }
      });
      
      // Créer une nouvelle clé API
      document.getElementById('createKeyForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const keyData = {
          application_id: document.getElementById('keyApp').value,
          description: document.getElementById('keyDescription').value
        };
        
        try {
          const result = await fetchWithAuth('/api/api-keys', {
            method: 'POST',
            body: JSON.stringify(keyData)
          });
          
          if (result && result.key) {
            document.getElementById('newApiKey').textContent = result.key;
            closeAllModals();
            openModal('newKeyModal');
            loadApiKeys();
          }
        } catch (error) {
          showError(error.message);
        }
      });
      
      // Copier la nouvelle clé API
      document.getElementById('copyKeyBtn').addEventListener('click', function() {
        const key = document.getElementById('newApiKey').textContent;
        copyToClipboard(key);
        alert('Clé API copiée dans le presse-papier');
      });
    }
    
    async function loadApplications() {
      try {
        const applicationsList = document.getElementById('applicationsList');
        applicationsList.innerHTML = '<tr><td colspan="5" class="loading-row">Chargement des applications...</td></tr>';
        
        const response = await fetchWithAuth('/api/applications');
        
        // Vérifier la structure de la réponse
        console.log('Applications response:', response);
        
        // Ajout de vérification robuste pour éviter l'erreur "Cannot read properties of undefined"
        if (!response) {
          throw new Error('Réponse vide ou invalide');
        }
        
        // Extraire les données depuis la réponse
        // La structure peut être soit {success: true, data: [...]} soit directement un tableau
        let applications = [];
        
        if (response.success && Array.isArray(response.data)) {
          // Format {success: true, data: [...]}
          applications = response.data;
        } else if (Array.isArray(response)) {
          // Format direct [...]
          applications = response;
        } else if (response.data && Array.isArray(response.data)) {
          // Au cas où data existe mais success n'existe pas
          applications = response.data;
        } else {
          console.error('Format de réponse non reconnu:', response);
          applicationsList.innerHTML = '<tr><td colspan="5" class="empty-row">Erreur: format de données invalide</td></tr>';
          return;
        }
        
        if (applications.length === 0) {
          applicationsList.innerHTML = '<tr><td colspan="5" class="empty-row">Aucune application trouvée</td></tr>';
          return;
        }
        
        applicationsList.innerHTML = '';
        applications.forEach(app => {
          applicationsList.innerHTML += `
            <tr>
              <td>${app.name}</td>
              <td>${app.description || '-'}</td>
              <td>${formatDate(app.created_at)}</td>
              <td>
                <button class="btn btn-sm btn-primary create-key" data-id="${app.id}" data-name="${app.name}">
                  <i class="fas fa-key"></i> Nouvelle clé
                </button>
              </td>
              <td>
                <button class="btn btn-icon edit-app" data-id="${app.id}" data-name="${app.name}" data-description="${app.description || ''}" data-cors="${app.cors_origins || ''}">
                  <i class="fas fa-pencil-alt"></i>
                </button>
                <button class="btn btn-icon delete-app" data-id="${app.id}">
                  <i class="fas fa-trash"></i>
                </button>
              </td>
            </tr>
          `;
        });
        
        // Attacher les événements aux boutons
        document.querySelectorAll('.create-key').forEach(button => {
          button.addEventListener('click', function() {
            const appId = this.getAttribute('data-id');
            const appName = this.getAttribute('data-name');
            
            document.getElementById('keyApp').value = appId;
            document.getElementById('keyDescription').value = '';
            
            openModal('createKeyModal');
          });
        });
      } catch (error) {
        showError('Erreur lors du chargement des applications: ' + error.message);
      }
    }
    
    async function loadApiKeys() {
      try {
        const keysList = document.getElementById('apiKeysList');
        keysList.innerHTML = '<tr><td colspan="6" class="loading-row">Chargement des clés API...</td></tr>';
        
        const response = await fetchWithAuth('/api/api-keys');
        
        // Vérifier la structure de la réponse
        console.log('API Keys response:', response);
        
        // Ajout de vérification robuste pour éviter l'erreur "Cannot read properties of undefined"
        if (!response) {
          throw new Error('Réponse vide ou invalide');
        }
        
        // Extraire les données depuis la réponse
        // La structure peut être soit {success: true, data: [...]} soit directement un tableau
        let keys = [];
        
        if (response.success && Array.isArray(response.data)) {
          // Format {success: true, data: [...]}
          keys = response.data;
        } else if (Array.isArray(response)) {
          // Format direct [...]
          keys = response;
        } else if (response.data && Array.isArray(response.data)) {
          // Au cas où data existe mais success n'existe pas
          keys = response.data;
        } else {
          console.error('Format de réponse non reconnu:', response);
          keysList.innerHTML = '<tr><td colspan="6" class="empty-row">Erreur: format de données invalide</td></tr>';
          return;
        }
        
        if (keys.length === 0) {
          keysList.innerHTML = '<tr><td colspan="6" class="empty-row">Aucune clé API trouvée</td></tr>';
          return;
        }
        
        keysList.innerHTML = '';
        keys.forEach(key => {
          keysList.innerHTML += `
            <tr>
              <td>${key.application_name}</td>
              <td><code>${key.key.substring(0, 8)}...</code></td>
              <td>${key.description || '-'}</td>
              <td>${formatDate(key.created_at)}</td>
              <td>
                <span class="status-badge ${key.is_active ? 'status-active' : 'status-inactive'}">
                  ${key.is_active ? 'Active' : 'Inactive'}
                </span>
              </td>
              <td>
                <button class="btn btn-icon toggle-key" data-id="${key.id}" data-active="${key.is_active}">
                  <i class="fas ${key.is_active ? 'fa-toggle-on' : 'fa-toggle-off'}"></i>
                </button>
                <button class="btn btn-icon delete-key" data-id="${key.id}">
                  <i class="fas fa-trash"></i>
                </button>
              </td>
            </tr>
          `;
        });
        
        // Attacher les événements aux boutons
        document.querySelectorAll('.toggle-key').forEach(button => {
          button.addEventListener('click', async function() {
            const keyId = this.getAttribute('data-id');
            const isActive = this.getAttribute('data-active') === 'true';
            
            try {
              await fetchWithAuth(`/api/api-keys/${keyId}`, {
                method: 'PUT',
                body: JSON.stringify({ is_active: !isActive })
              });
              
              loadApiKeys();
            } catch (error) {
              showError(error.message);
            }
          });
        });
        
        document.querySelectorAll('.delete-key').forEach(button => {
          button.addEventListener('click', async function() {
            const keyId = this.getAttribute('data-id');
            
            if (confirm('Êtes-vous sûr de vouloir supprimer cette clé API ?')) {
              try {
                await fetchWithAuth(`/api/api-keys/${keyId}`, {
                  method: 'DELETE'
                });
                
                loadApiKeys();
              } catch (error) {
                showError(error.message);
              }
            }
          });
        });
      } catch (error) {
        showError('Erreur lors du chargement des clés API: ' + error.message);
      }
    }
    
    // Gestion des terminologies
    function initializeTerminologyEvents() {
      // Ouvrir le modal d'import de terminologie
      document.getElementById('import-terminology-btn').addEventListener('click', function() {
        openModal('file-upload-modal');
      });
      
      // Rafraîchir les terminologies
      document.getElementById('refresh-terminology-btn').addEventListener('click', function() {
        loadTerminologyFiles();
        loadTerminologyStats();
      });
      
      // Sélectionner des fichiers à importer
      document.getElementById('browse-terminology-files').addEventListener('click', function() {
        // Ici, vous pouvez implémenter la logique pour sélectionner des fichiers
        alert('Fonction de sélection de fichiers à implémenter');
      });
    }
    
    async function loadTerminologyFiles() {
      try {
        const filesTable = document.getElementById('terminology-files-table');
        filesTable.innerHTML = '<tr><td colspan="6" class="loading-row">Chargement des fichiers...</td></tr>';
        
        const response = await fetchWithAuth('/api/terminology/files');
        
        // Vérifier la structure de la réponse
        console.log('Terminology files response:', response);
        
        // Extraire les données depuis la réponse
        let files = [];
        
        if (response && response.success && Array.isArray(response.data)) {
          // Format API moderne avec { success: true, data: [...] }
          files = response.data;
        } else if (Array.isArray(response)) {
          // Format API simple array
          files = response;
        } else if (response && typeof response === 'object') {
          // Autre format potentiel
          files = response.files || response.data || [];
        }
        
        if (!files || !Array.isArray(files) || files.length === 0) {
          filesTable.innerHTML = '<tr><td colspan="6" class="empty-row">Aucun fichier de terminologie trouvé</td></tr>';
          return;
        }
        
        filesTable.innerHTML = '';
        files.forEach(file => {
          // Pour déboguer
          console.log('Processing file:', file);
          
          // Déterminer le nom de fichier à partir des propriétés disponibles
          const filename = file.filename || file.name || file.file || 'Sans nom';
          
          // Récupérer l'ID de manière sécurisée
          const fileId = file.id || '';
          
          // Créer un ID de donnée sécurisé pour les attributs data-*
          const safeFilename = filename.replace(/[^a-z0-9]/gi, '_');
          
          // Gérer la date dans différents formats
          let dateStr = 'N/A';
          if (file.last_updated) {
            dateStr = formatDate(file.last_updated);
          } else if (file.lastModified) {
            dateStr = formatDate(new Date(file.lastModified));
          } else if (file.updated_at) {
            dateStr = formatDate(file.updated_at);
          }
          
          filesTable.innerHTML += `
            <tr>
              <td>${filename}</td>
              <td>${file.type || 'Inconnu'}</td>
              <td>${file.description || '-'}</td>
              <td>${dateStr}</td>
              <td>${file.count || file.size ? (file.size + ' octets') : '0 éléments'}</td>
              <td>
                <button class="btn btn-icon view-file" data-id="${fileId}" data-filename="${safeFilename}">
                  <i class="fas fa-eye"></i>
                </button>
                <button class="btn btn-icon delete-file" data-id="${fileId}" data-filename="${safeFilename}">
                  <i class="fas fa-trash"></i>
                </button>
              </td>
            </tr>
          `;
        });
      } catch (error) {
        showError('Erreur lors du chargement des fichiers de terminologie: ' + error.message);
      }
    }
    
    async function loadTerminologyStats() {
      try {
        const response = await fetchWithAuth('/api/terminology/stats');
        
        // Vérifier la structure de la réponse
        console.log('Terminology stats response:', response);
        
        // Extraire les données depuis la réponse
        const stats = response.data || response || {};
        
        document.getElementById('terminology-version').textContent = stats.version || 'N/A';
        document.getElementById('terminology-last-updated').textContent = stats.last_updated ? formatDate(stats.last_updated) : 'Jamais';
        document.getElementById('terminology-files-count').textContent = stats.files_count || '0';
        document.getElementById('terminology-systems-count').textContent = stats.systems_count || '0';
        document.getElementById('terminology-oids-count').textContent = stats.oids_count || '0';
      } catch (error) {
        console.error('Erreur lors du chargement des statistiques de terminologie:', error);
        
        // En cas d'erreur 404 ou autre, définir les valeurs par défaut
        document.getElementById('terminology-version').textContent = 'N/A';
        document.getElementById('terminology-last-updated').textContent = 'Jamais';
        document.getElementById('terminology-files-count').textContent = '0';
        document.getElementById('terminology-systems-count').textContent = '0';
        document.getElementById('terminology-oids-count').textContent = '0';
      }
    }
    
    // Gestion des paramètres IA
    function initializeAISettingsEvents() {
      // Ouvrir le modal de sélection de fournisseur IA
      document.getElementById('add-ai-provider-btn').addEventListener('click', function() {
        openModal('provider-selection-modal');
        loadAIProvidersList();
      });
      
      // Tester la connexion à l'API d'IA
      document.getElementById('test-ai-btn').addEventListener('click', function() {
        if (document.querySelector('#api-list .api-card')) {
          // Si un fournisseur existe, tester le premier
          const providerId = document.querySelector('#api-list .api-card').getAttribute('data-id');
          testAIProvider(providerId);
        } else {
          showError('Aucun fournisseur d\'IA configuré à tester');
        }
      });
    }
    
    async function loadAIProviders() {
      try {
        const apiList = document.getElementById('api-list');
        const noApis = document.getElementById('no-apis');
        const loadingSpinner = document.getElementById('loading-spinner');
        
        loadingSpinner.style.display = 'block';
        noApis.classList.add('hidden');
        
        const response = await fetchWithAuth('/api/ai-providers');
        
        // Vérifier la structure de la réponse
        console.log('AI Providers response:', response);
        
        // Extraire les données depuis la réponse
        let providers = [];
        
        if (response && response.success && Array.isArray(response.data)) {
          // Format API moderne avec { success: true, data: [...] }
          providers = response.data;
        } else if (Array.isArray(response)) {
          // Format API simple array
          providers = response;
        } else if (response && typeof response === 'object') {
          // Autre format potentiel
          providers = response.providers || response.data || [];
        }
        
        loadingSpinner.style.display = 'none';
        
        if (!providers || !Array.isArray(providers) || providers.length === 0) {
          noApis.classList.remove('hidden');
          return;
        }
        
        let html = '';
        providers.forEach(provider => {
          // Pour déboguer
          console.log('Processing provider:', provider);
          
          // Sécuriser l'accès aux propriétés
          const id = provider.id || '';
          const name = provider.name || provider.provider_name || 'Fournisseur IA';
          const description = provider.description || 'Aucune description disponible';
          const models = provider.models || 'Par défaut';
          const created_at = provider.created_at || new Date().toISOString();
          
          // Déterminer le statut
          const isEnabled = provider.enabled === 1 || provider.enabled === true || 
                          provider.status === 'active' || provider.status === 'enabled';
          const statusClass = isEnabled ? 'ai-status-active' : 'ai-status-inactive';
          const statusText = isEnabled ? 'Actif' : 'Inactif';
          
          html += `
            <div class="ai-card" data-id="${id}">
              <div class="ai-card-header">
                <h3>
                  <i class="ai-provider-icon ${getProviderIcon(name)}"></i>
                  ${name}
                </h3>
                <span class="ai-status ${statusClass}">${statusText}</span>
              </div>
              <div class="ai-card-body">
                <p>${description}</p>
                <div class="ai-card-info">
                  <span>Modèles: ${models}</span>
                  <span>Ajouté le: ${formatDate(created_at)}</span>
                </div>
                <div class="ai-card-actions">
                  <button class="btn btn-sm btn-secondary test-provider" data-id="${id}">
                    <i class="fas fa-vial"></i> Tester
                  </button>
                  <button class="btn btn-sm btn-primary edit-provider" data-id="${id}">
                    <i class="fas fa-pencil-alt"></i> Modifier
                  </button>
                  <button class="btn btn-sm btn-danger delete-provider" data-id="${id}">
                    <i class="fas fa-trash"></i> Supprimer
                  </button>
                </div>
              </div>
            </div>
          `;
        });
        
        apiList.innerHTML = html + loadingSpinner.outerHTML + noApis.outerHTML;
        
        // Attacher les événements aux boutons
        document.querySelectorAll('.test-provider').forEach(button => {
          button.addEventListener('click', function() {
            const providerId = this.getAttribute('data-id');
            testAIProvider(providerId);
          });
        });
        
        document.querySelectorAll('.edit-provider').forEach(button => {
          button.addEventListener('click', function() {
            const providerId = this.getAttribute('data-id');
            editAIProvider(providerId);
          });
        });
        
        document.querySelectorAll('.delete-provider').forEach(button => {
          button.addEventListener('click', function() {
            const providerId = this.getAttribute('data-id');
            if (confirm('Êtes-vous sûr de vouloir supprimer ce fournisseur d\'IA ?')) {
              deleteAIProvider(providerId);
            }
          });
        });
      } catch (error) {
        showError('Erreur lors du chargement des fournisseurs d\'IA: ' + error.message);
      }
    }
    
    async function loadAIProvidersList() {
      try {
        const providerList = document.getElementById('provider-list');
        providerList.innerHTML = '<div class="loading-spinner"><i class="fas fa-spinner fa-spin"></i> Chargement des fournisseurs...</div>';
        
        const response = await fetchWithAuth('/api/ai-providers/supported');
        
        // Vérifier la structure de la réponse
        console.log('AI Providers List response:', response);
        
        // Extraire les données depuis la réponse
        let providers = [];
        
        if (response && response.success && Array.isArray(response.data)) {
          // Format API moderne avec { success: true, data: [...] }
          providers = response.data;
        } else if (Array.isArray(response)) {
          // Format API simple array
          providers = response;
        } else if (response && typeof response === 'object') {
          // Autre format potentiel
          providers = response.providers || response.data || [];
        }
        
        if (!providers || !Array.isArray(providers) || providers.length === 0) {
          providerList.innerHTML = '<div class="alert alert-info">Aucun fournisseur d\'IA disponible</div>';
          return;
        }
        
        let html = '';
        providers.forEach(provider => {
          // Pour déboguer
          console.log('Processing supported provider:', provider);
          
          // Sécuriser l'accès aux propriétés
          const name = provider.name || provider.provider_name || 'Fournisseur IA';
          const displayName = provider.display_name || name;
          const description = provider.description || 'Aucune description disponible';
          
          html += `
            <div class="ai-provider-card" data-name="${name}">
              <div class="ai-provider-logo">
                <i class="${getProviderIcon(name)}"></i>
              </div>
              <h3 class="ai-provider-title">${displayName}</h3>
              <p class="ai-provider-description">${description}</p>
            </div>
          `;
        });
        
        providerList.innerHTML = html;
        
        // Attacher les événements de sélection
        document.querySelectorAll('.ai-provider-card').forEach(card => {
          card.addEventListener('click', function() {
            const providerName = this.getAttribute('data-name');
            closeAllModals();
            openAddProviderModal(providerName);
          });
        });
      } catch (error) {
        showError('Erreur lors du chargement de la liste des fournisseurs d\'IA: ' + error.message);
      }
    }
    
    function openAddProviderModal(providerName = '') {
      document.getElementById('provider-form').reset();
      document.getElementById('provider-mode').value = 'add';
      document.getElementById('provider-modal-title').textContent = 'Ajouter un fournisseur d\'IA';
      document.getElementById('provider-id').value = '';
      
      if (providerName) {
        document.getElementById('provider-name').value = providerName;
      }
      
      document.getElementById('api-key-info').classList.add('hidden');
      document.getElementById('test-result').classList.add('hidden');
      
      openModal('provider-modal');
    }
    
    async function editAIProvider(providerId) {
      try {
        const response = await fetchWithAuth(`/api/ai-providers/${providerId}`);
        console.log('Edit provider response:', response);
        
        // Extraire les données depuis la réponse
        let provider = {};
        if (response && response.success && response.data) {
          provider = response.data;
        } else if (response && typeof response === 'object') {
          provider = response;
        }
        
        document.getElementById('provider-form').reset();
        document.getElementById('provider-mode').value = 'edit';
        document.getElementById('provider-modal-title').textContent = 'Modifier le fournisseur d\'IA';
        document.getElementById('provider-id').value = providerId;
        
        // Extraire les propriétés de manière sécurisée
        const name = provider.name || provider.provider_name || '';
        const apiUrl = provider.api_url || '';
        const models = provider.models || '';
        
        document.getElementById('provider-name').value = name;
        document.getElementById('api-url').value = apiUrl;
        document.getElementById('api-models').value = models;
        
        // Déterminer le statut
        const isEnabled = provider.enabled === 1 || provider.enabled === true || 
                          provider.status === 'active' || provider.status === 'enabled';
        
        // Définir le statut
        if (isEnabled) {
          document.getElementById('status-active').checked = true;
        } else {
          document.getElementById('status-inactive').checked = true;
        }
        
        // Paramètres avancés - gérer différentes structures possibles
        let settings = {};
        if (typeof provider.settings === 'string') {
          try {
            settings = JSON.parse(provider.settings);
          } catch (e) {
            console.error('Erreur lors de la conversion des paramètres:', e);
          }
        } else if (provider.settings && typeof provider.settings === 'object') {
          settings = provider.settings;
        }
        
        document.getElementById('settings').value = JSON.stringify(settings, null, 2);
        
        // Afficher l'info de clé
        document.getElementById('api-key-info').classList.remove('hidden');
        document.getElementById('test-result').classList.add('hidden');
        
        openModal('provider-modal');
      } catch (error) {
        console.error('Erreur complète:', error);
        showError('Erreur lors du chargement du fournisseur d\'IA: ' + error.message);
      }
    }
    
    async function testAIProvider(providerId) {
      try {
        const testResult = document.getElementById('test-result');
        testResult.innerHTML = '<div class="loading-spinner"><i class="fas fa-spinner fa-spin"></i> Test en cours...</div>';
        testResult.classList.remove('hidden');
        testResult.classList.remove('test-success', 'test-error');
        
        const result = await fetchWithAuth(`/api/ai-providers/${providerId}/test`, {
          method: 'POST'
        });
        
        if (result.success) {
          testResult.innerHTML = `
            <div class="test-success">
              <i class="fas fa-check-circle"></i> 
              <strong>Test réussi!</strong>
              <p>${result.message || 'La connexion au fournisseur d\'IA fonctionne correctement.'}</p>
            </div>
          `;
        } else {
          testResult.innerHTML = `
            <div class="test-error">
              <i class="fas fa-exclamation-circle"></i>
              <strong>Échec du test</strong>
              <p>${result.message || 'La connexion au fournisseur d\'IA a échoué.'}</p>
            </div>
          `;
        }
      } catch (error) {
        const testResult = document.getElementById('test-result');
        testResult.innerHTML = `
          <div class="test-error">
            <i class="fas fa-exclamation-circle"></i>
            <strong>Erreur de test</strong>
            <p>${error.message || 'Une erreur est survenue lors du test de connexion.'}</p>
          </div>
        `;
        testResult.classList.remove('hidden');
      }
    }
    
    async function deleteAIProvider(providerId) {
      try {
        await fetchWithAuth(`/api/ai-providers/${providerId}`, {
          method: 'DELETE'
        });
        
        loadAIProviders();
      } catch (error) {
        showError('Erreur lors de la suppression du fournisseur d\'IA: ' + error.message);
      }
    }
    
    // Fonction utilitaire pour obtenir l'icône du fournisseur
    function getProviderIcon(providerName) {
      const icons = {
        'openai': 'fab fa-openai',
        'mistral': 'fas fa-brain',
        'anthropic': 'fas fa-robot',
        'gemini': 'fas fa-gem'
      };
      
      // Vérifier si providerName est défini avant d'appeler toLowerCase
      if (!providerName) return 'fas fa-cog';
      
      // Assurez-vous que c'est bien une chaîne de caractères
      const name = typeof providerName === 'string' ? providerName : String(providerName);
      
      return icons[name.toLowerCase()] || 'fas fa-cog';
    }
  </script>
</body>
</html>