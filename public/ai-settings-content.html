<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Paramètres IA - Contenu</title>
  <link rel="stylesheet" href="/css/styles.css">
  <link rel="stylesheet" href="/css/admin.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
  <style>
    body {
      padding: 0;
      margin: 0;
    }
    
    .ai-settings-container {
      margin-top: 0;
    }
    
    .page-header {
      display: none;
    }
    
    .ai-provider {
      margin-bottom: 1.5rem;
      padding: 1.25rem;
      border-radius: 8px;
      background-color: #fff;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    
    .provider-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }
    
    .provider-logo {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .provider-logo i {
      font-size: 1.5rem;
      color: #e74c3c;
      background: linear-gradient(135deg, #e74c3c, #ff7675);
      padding: 10px;
      border-radius: 50%;
      color: #fff;
    }
    
    .provider-name {
      font-size: 1.25rem;
      font-weight: 600;
      color: #2d3748;
    }
    
    .provider-status {
      font-size: 0.875rem;
      padding: 0.25rem 0.75rem;
      border-radius: 100px;
      font-weight: 500;
    }
    
    .status-active {
      background-color: #eafaf1;
      color: #27ae60;
    }
    
    .status-inactive {
      background-color: #f8f9fa;
      color: #95a5a6;
    }
    
    .provider-details {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 1.5rem;
      margin-bottom: 1rem;
    }
    
    .provider-detail {
      display: flex;
      flex-direction: column;
    }
    
    .detail-label {
      font-size: 0.875rem;
      color: #718096;
      margin-bottom: 0.375rem;
    }
    
    .detail-value {
      font-size: 0.9375rem;
      color: #2d3748;
      font-weight: 500;
      word-break: break-word;
    }
    
    .provider-actions {
      display: flex;
      gap: 0.75rem;
      justify-content: flex-end;
      margin-top: 1rem;
    }
    
    .no-providers {
      text-align: center;
      padding: 2.5rem;
      background-color: #f8f9fa;
      border-radius: 8px;
      margin-bottom: 1.5rem;
    }
    
    .no-providers i {
      font-size: 3rem;
      color: #cbd5e0;
      margin-bottom: 1rem;
    }
    
    .no-providers h3 {
      margin: 0 0 0.75rem;
      color: #4a5568;
    }
    
    .no-providers p {
      margin: 0;
      color: #718096;
      max-width: 35rem;
      margin: 0 auto;
    }
    
    .provider-form-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }
    
    @media (max-width: 768px) {
      .provider-form-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="ai-settings-container">
    <div class="ai-providers-list" id="providers-list">
      <!-- Les fournisseurs d'IA seront chargés ici -->
      <div class="loading">
        <i class="fas fa-spinner fa-spin"></i> Chargement des fournisseurs d'IA...
      </div>
    </div>
  </div>
  
  <!-- Modal d'ajout/modification de fournisseur IA -->
  <div id="provider-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title" id="provider-modal-title">Ajouter un fournisseur d'IA</h2>
      </div>
      
      <div class="modal-body">
        <form id="provider-form">
          <input type="hidden" id="provider-id">
          
          <div class="provider-form-grid">
            <div class="form-group">
              <label for="provider-name" class="form-label">Nom</label>
              <input type="text" id="provider-name" class="form-input" required>
            </div>
            
            <div class="form-group">
              <label for="provider-type" class="form-label">Type</label>
              <select id="provider-type" class="form-select" required>
                <option value="">-- Sélectionner un type --</option>
                <option value="openai">OpenAI</option>
                <option value="mistral">Mistral AI</option>
                <option value="anthropic">Anthropic</option>
                <option value="huggingface">Hugging Face</option>
                <option value="gemini">Google Gemini</option>
                <option value="custom">Personnalisé</option>
              </select>
            </div>
          </div>
          
          <div class="form-group">
            <label for="provider-api-key" class="form-label">Clé API</label>
            <input type="password" id="provider-api-key" class="form-input" required>
          </div>
          
          <div class="provider-form-grid">
            <div class="form-group">
              <label for="provider-api-url" class="form-label">URL de l'API</label>
              <input type="text" id="provider-api-url" class="form-input" placeholder="https://api.openai.com/v1">
            </div>
            
            <div class="form-group">
              <label for="provider-model" class="form-label">Modèle</label>
              <input type="text" id="provider-model" class="form-input" placeholder="gpt-4o, claude-3, mistral-large-latest">
            </div>
          </div>
          
          <div class="form-group">
            <label class="form-label">Paramètres avancés</label>
            <div class="provider-form-grid">
              <div class="form-group">
                <label for="provider-temperature" class="form-label">Température</label>
                <input type="number" id="provider-temperature" min="0" max="1" step="0.1" class="form-input" value="0.7">
              </div>
              
              <div class="form-group">
                <label for="provider-max-tokens" class="form-label">Tokens maximum</label>
                <input type="number" id="provider-max-tokens" min="1" class="form-input" value="1000">
              </div>
            </div>
          </div>
          
          <div class="form-group">
            <div class="checkbox-container">
              <input type="checkbox" id="provider-enabled" checked>
              <label for="provider-enabled">Activé</label>
            </div>
          </div>
        </form>
      </div>
      
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" id="cancel-provider-btn">Annuler</button>
        <button type="button" class="btn btn-primary" id="save-provider-btn">Enregistrer</button>
      </div>
    </div>
  </div>
  
  <!-- Modal de test de l'API IA -->
  <div id="test-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">Tester un fournisseur d'IA</h2>
      </div>
      
      <div class="modal-body">
        <div class="form-group">
          <label for="test-provider" class="form-label">Fournisseur</label>
          <select id="test-provider" class="form-select" required>
            <option value="">-- Sélectionner un fournisseur --</option>
            <!-- Options ajoutées dynamiquement -->
          </select>
        </div>
        
        <div class="form-group">
          <label for="test-prompt" class="form-label">Message de test</label>
          <textarea id="test-prompt" class="form-textarea" rows="3" required>Bonjour, ceci est un test. Peux-tu m'indiquer quelles sont tes capacités ?</textarea>
        </div>
        
        <div class="test-results">
          <label class="form-label">Résultat</label>
          <div id="test-result" class="test-result-container">
            <div class="placeholder">Les résultats du test s'afficheront ici.</div>
          </div>
        </div>
      </div>
      
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" id="close-test-btn">Fermer</button>
        <button type="button" class="btn btn-primary" id="run-test-btn">Exécuter le test</button>
      </div>
    </div>
  </div>
  
  <!-- Modal de confirmation de suppression -->
  <div id="delete-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">Confirmer la suppression</h2>
      </div>
      
      <div class="modal-body">
        <p>Êtes-vous sûr de vouloir supprimer ce fournisseur d'IA ? Cette action est irréversible.</p>
      </div>
      
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" id="cancel-delete-btn">Annuler</button>
        <button type="button" class="btn btn-danger" id="confirm-delete-btn">Supprimer</button>
      </div>
    </div>
  </div>

  <script>
    let providers = [];
    let providerToDelete = null;
    
    document.addEventListener('DOMContentLoaded', function() {
      // Charger les fournisseurs
      loadProviders();
      
      // Gestionnaires d'événements pour les boutons
      document.getElementById('cancel-provider-btn').addEventListener('click', closeProviderModal);
      document.getElementById('save-provider-btn').addEventListener('click', saveProvider);
      document.getElementById('close-test-btn').addEventListener('click', closeTestModal);
      document.getElementById('run-test-btn').addEventListener('click', runTest);
      document.getElementById('cancel-delete-btn').addEventListener('click', closeDeleteModal);
      document.getElementById('confirm-delete-btn').addEventListener('click', deleteProvider);
      
      // Exposer les fonctions pour qu'elles puissent être appelées depuis la page parent
      window.openAddProviderModal = openAddProviderModal;
      window.testAIProvider = openTestModal;
    });
    
    function loadProviders() {
      // Utilisation de la fonction d'authentification avec la clé API
      if (window.parent.FHIRHubAuth && window.parent.FHIRHubAuth.fetchWithAuth) {
        window.parent.FHIRHubAuth.fetchWithAuth('/api/ai-providers', { method: 'GET' }, true)
          .then(response => response.json())
          .then(data => {
            providers = data.success ? data.data : [];
            renderProviders();
            updateTestProviderOptions();
          })
          .catch(error => {
            console.error('Erreur:', error);
            showError('Une erreur est survenue lors de la récupération des fournisseurs d\'IA.');
          });
      } else {
        // Fallback si la fonction d'authentification n'est pas disponible
        fetch('/api/ai-providers', {
          method: 'GET',
          headers: {
            'X-API-KEY': 'dev-key'
          }
        })
      .then(response => response.json())
      .then(data => {
        providers = data.success ? data.data : [];
        renderProviders();
        updateTestProviderOptions();
      })
      .catch(error => {
        console.error('Erreur:', error);
        showError('Une erreur est survenue lors de la récupération des fournisseurs d\'IA.');
      });
    }
    
    function renderProviders() {
      const container = document.getElementById('providers-list');
      container.innerHTML = '';
      
      if (providers.length === 0) {
        container.innerHTML = `
          <div class="no-providers">
            <i class="fas fa-robot"></i>
            <h3>Aucun fournisseur d'IA configuré</h3>
            <p>
              Ajoutez un fournisseur d'IA pour activer les fonctionnalités d'intelligence artificielle 
              comme l'assistance conversationnelle et l'enrichissement des données.
            </p>
          </div>
        `;
        return;
      }
      
      providers.forEach(provider => {
        const providerElement = document.createElement('div');
        providerElement.className = 'ai-provider';
        
        // Déterminer l'icône en fonction du type
        let providerIcon = 'fa-robot';
        switch (provider.type.toLowerCase()) {
          case 'openai':
            providerIcon = 'fa-brain';
            break;
          case 'mistral':
            providerIcon = 'fa-wind';
            break;
          case 'anthropic':
            providerIcon = 'fa-atom';
            break;
          case 'huggingface':
            providerIcon = 'fa-smile';
            break;
          case 'gemini':
            providerIcon = 'fa-gem';
            break;
        }
        
        // Formater la date d'ajout
        const dateAdded = new Date(provider.created_at);
        const formattedDate = dateAdded.toLocaleDateString('fr-FR');
        
        // Formater la dernière mise à jour
        const lastUpdate = new Date(provider.updated_at || provider.created_at);
        const formattedUpdate = lastUpdate.toLocaleDateString('fr-FR');
        
        providerElement.innerHTML = `
          <div class="provider-header">
            <div class="provider-logo">
              <i class="fas ${providerIcon}"></i>
              <div class="provider-name">${provider.name}</div>
            </div>
            <div class="provider-status ${provider.enabled ? 'status-active' : 'status-inactive'}">
              ${provider.enabled ? 'Actif' : 'Inactif'}
            </div>
          </div>
          
          <div class="provider-details">
            <div class="provider-detail">
              <div class="detail-label">Type</div>
              <div class="detail-value">${provider.type}</div>
            </div>
            
            <div class="provider-detail">
              <div class="detail-label">URL de l'API</div>
              <div class="detail-value">${provider.api_url || '(Par défaut)'}</div>
            </div>
            
            <div class="provider-detail">
              <div class="detail-label">Modèle</div>
              <div class="detail-value">${provider.model || '(Par défaut)'}</div>
            </div>
            
            <div class="provider-detail">
              <div class="detail-label">Ajouté le</div>
              <div class="detail-value">${formattedDate}</div>
            </div>
            
            <div class="provider-detail">
              <div class="detail-label">Dernière mise à jour</div>
              <div class="detail-value">${formattedUpdate}</div>
            </div>
          </div>
          
          <div class="provider-actions">
            <button class="btn btn-outline test-btn" data-id="${provider.id}">
              <i class="fas fa-vial"></i> Tester
            </button>
            <button class="btn btn-outline edit-btn" data-id="${provider.id}">
              <i class="fas fa-edit"></i> Modifier
            </button>
            <button class="btn btn-outline-danger delete-btn" data-id="${provider.id}" data-name="${provider.name}">
              <i class="fas fa-trash-alt"></i> Supprimer
            </button>
          </div>
        `;
        
        container.appendChild(providerElement);
      });
      
      // Ajouter les gestionnaires d'événements
      document.querySelectorAll('.test-btn').forEach(button => {
        button.addEventListener('click', function() {
          const providerId = this.getAttribute('data-id');
          openTestModal(providerId);
        });
      });
      
      document.querySelectorAll('.edit-btn').forEach(button => {
        button.addEventListener('click', function() {
          const providerId = this.getAttribute('data-id');
          const provider = providers.find(p => p.id === parseInt(providerId));
          if (provider) {
            openEditProviderModal(provider);
          }
        });
      });
      
      document.querySelectorAll('.delete-btn').forEach(button => {
        button.addEventListener('click', function() {
          const providerId = this.getAttribute('data-id');
          const providerName = this.getAttribute('data-name');
          openDeleteModal(providerId, providerName);
        });
      });
    }
    
    function updateTestProviderOptions() {
      const select = document.getElementById('test-provider');
      
      // Vider les options existantes
      select.innerHTML = '<option value="">-- Sélectionner un fournisseur --</option>';
      
      // Ajouter les fournisseurs actifs
      const activeProviders = providers.filter(p => p.enabled);
      activeProviders.forEach(provider => {
        const option = document.createElement('option');
        option.value = provider.id;
        option.textContent = provider.name;
        select.appendChild(option);
      });
    }
    
    function openAddProviderModal() {
      // Réinitialiser le formulaire
      document.getElementById('provider-form').reset();
      document.getElementById('provider-id').value = '';
      document.getElementById('provider-modal-title').textContent = 'Ajouter un fournisseur d\'IA';
      
      // Afficher la modale
      document.getElementById('provider-modal').style.display = 'block';
    }
    
    function openEditProviderModal(provider) {
      // Remplir le formulaire avec les données du fournisseur
      document.getElementById('provider-id').value = provider.id;
      document.getElementById('provider-name').value = provider.name;
      document.getElementById('provider-type').value = provider.type.toLowerCase();
      document.getElementById('provider-api-key').value = '••••••••••••••••'; // Masquer la clé API
      document.getElementById('provider-api-url').value = provider.api_url || '';
      document.getElementById('provider-model').value = provider.model || '';
      document.getElementById('provider-temperature').value = provider.temperature || 0.7;
      document.getElementById('provider-max-tokens').value = provider.max_tokens || 1000;
      document.getElementById('provider-enabled').checked = provider.enabled;
      
      // Changer le titre de la modale
      document.getElementById('provider-modal-title').textContent = 'Modifier le fournisseur d\'IA';
      
      // Afficher la modale
      document.getElementById('provider-modal').style.display = 'block';
    }
    
    function closeProviderModal() {
      document.getElementById('provider-modal').style.display = 'none';
    }
    
    function openTestModal(providerId = null) {
      // Réinitialiser les résultats
      document.getElementById('test-result').innerHTML = '<div class="placeholder">Les résultats du test s\'afficheront ici.</div>';
      
      // Si un ID est fourni, sélectionner ce fournisseur
      if (providerId) {
        document.getElementById('test-provider').value = providerId;
      }
      
      // Afficher la modale
      document.getElementById('test-modal').style.display = 'block';
    }
    
    function closeTestModal() {
      document.getElementById('test-modal').style.display = 'none';
    }
    
    function openDeleteModal(providerId, providerName) {
      // Stocker l'ID du fournisseur à supprimer
      providerToDelete = providerId;
      
      // Personnaliser le message
      const message = document.querySelector('#delete-modal .modal-body p');
      message.textContent = `Êtes-vous sûr de vouloir supprimer le fournisseur d'IA "${providerName}" ? Cette action est irréversible.`;
      
      // Afficher la modale
      document.getElementById('delete-modal').style.display = 'block';
    }
    
    function closeDeleteModal() {
      document.getElementById('delete-modal').style.display = 'none';
      providerToDelete = null;
    }
    
    function saveProvider() {
      // Récupérer les données du formulaire
      const providerId = document.getElementById('provider-id').value;
      const name = document.getElementById('provider-name').value;
      const type = document.getElementById('provider-type').value;
      const apiKey = document.getElementById('provider-api-key').value;
      const apiUrl = document.getElementById('provider-api-url').value;
      const model = document.getElementById('provider-model').value;
      const temperature = document.getElementById('provider-temperature').value;
      const maxTokens = document.getElementById('provider-max-tokens').value;
      const enabled = document.getElementById('provider-enabled').checked;
      
      // Valider les données
      if (!name || !type) {
        alert('Le nom et le type sont obligatoires.');
        return;
      }
      
      if (apiKey === '••••••••••••••••' && providerId) {
        // L'utilisateur n'a pas modifié la clé API, ne pas l'envoyer
        alert('La clé API n\'a pas été modifiée.');
        return;
      }
      
      // Construire l'objet fournisseur
      const providerData = {
        name,
        type,
        api_key: apiKey,
        api_url: apiUrl,
        model,
        temperature: parseFloat(temperature),
        max_tokens: parseInt(maxTokens),
        enabled
      };
      
      // Déterminer l'URL et la méthode
      const url = providerId ? `/api/ai-providers/${providerId}` : '/api/ai-providers';
      const method = providerId ? 'PUT' : 'POST';
      
      // Options de la requête
      const options = {
        method,
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(providerData)
      };
      
      // Envoyer la requête avec authentification
      if (window.parent.FHIRHubAuth && window.parent.FHIRHubAuth.fetchWithAuth) {
        window.parent.FHIRHubAuth.fetchWithAuth(url, options, true)
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              // Fermer la modale
              closeProviderModal();
              
              // Refresh la liste
              loadProviders();
              
              // Afficher un message de succès
              alert(providerId ? 'Fournisseur mis à jour avec succès.' : 'Fournisseur créé avec succès.');
            } else {
              alert(`Erreur: ${data.message || 'Une erreur est survenue.'}`);
            }
          })
          .catch(error => {
            console.error('Erreur:', error);
            alert('Une erreur est survenue lors de l\'enregistrement du fournisseur.');
          });
      } else {
        // Simuler une réponse réussie (pour la démo seulement)
        console.log(`Envoi de la requête ${method} à ${url}:`, providerData);
        setTimeout(() => {
          closeProviderModal();
          loadProviders();
          alert(providerId ? 'Fournisseur mis à jour avec succès.' : 'Fournisseur créé avec succès.');
        }, 500);
      }
    }
    
    function runTest() {
      const providerId = document.getElementById('test-provider').value;
      const prompt = document.getElementById('test-prompt').value;
      
      if (!providerId || !prompt) {
        alert('Veuillez sélectionner un fournisseur et saisir un message de test.');
        return;
      }
      
      // Afficher un message de chargement
      const resultContainer = document.getElementById('test-result');
      resultContainer.innerHTML = '<div class="loading"><i class="fas fa-spinner fa-spin"></i> Test en cours...</div>';
      
      // Options de la requête
      const options = {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          provider_id: providerId,
          prompt: prompt
        })
      };
      
      // Envoyer la requête avec authentification
      if (window.parent.FHIRHubAuth && window.parent.FHIRHubAuth.fetchWithAuth) {
        window.parent.FHIRHubAuth.fetchWithAuth('/api/ai-providers/test', options, true)
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              resultContainer.innerHTML = `<div class="test-response">${data.response.replace(/\n/g, '<br>')}</div>`;
            } else {
              resultContainer.innerHTML = `<div class="error-message">${data.message || 'Une erreur est survenue lors du test.'}</div>`;
            }
          })
          .catch(error => {
            console.error('Erreur:', error);
            resultContainer.innerHTML = `<div class="error-message">Une erreur est survenue lors du test.</div>`;
          });
      } else {
        // Simuler une réponse (pour la démo seulement)
        setTimeout(() => {
          const provider = providers.find(p => p.id === parseInt(providerId));
          const response = `En tant que modèle ${provider?.model || 'IA'} de ${provider?.name || 'fournisseur'}, je peux vous aider avec diverses tâches comme la rédaction de contenu, la réponse à des questions, la création de résumés, et bien plus encore.

Je suis conçu pour comprendre et générer du texte en langage naturel. N'hésitez pas à me poser vos questions ou à me demander de l'aide pour vos projets.`;
          
          resultContainer.innerHTML = `<div class="test-response">${response.replace(/\n/g, '<br>')}</div>`;
        }, 1500);
      }
    }
    
    function deleteProvider() {
      if (!providerToDelete) return;
      
      // Options de la requête
      const options = {
        method: 'DELETE'
      };
      
      // Envoyer la requête avec authentification
      if (window.parent.FHIRHubAuth && window.parent.FHIRHubAuth.fetchWithAuth) {
        window.parent.FHIRHubAuth.fetchWithAuth(`/api/ai-providers/${providerToDelete}`, options, true)
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              // Fermer la modale
              closeDeleteModal();
              
              // Refresh la liste
              loadProviders();
              
              // Afficher un message de succès
              alert('Fournisseur supprimé avec succès.');
            } else {
              alert(`Erreur: ${data.message || 'Une erreur est survenue.'}`);
            }
          })
          .catch(error => {
            console.error('Erreur:', error);
            alert('Une erreur est survenue lors de la suppression du fournisseur.');
          });
      } else {
        // Simuler une réponse réussie (pour la démo seulement)
        console.log(`Suppression du fournisseur ID: ${providerToDelete}`);
        setTimeout(() => {
          closeDeleteModal();
          loadProviders();
          alert('Fournisseur supprimé avec succès.');
        }, 500);
      }
    }
    
    function showError(message) {
      const container = document.getElementById('providers-list');
      container.innerHTML = `<div class="error-message">${message}</div>`;
    }
  </script>
</body>
</html>