version: '3.8'

services:
  # Application principale FHIRHub simplifiée
  fhirhub:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: fhirhub
    restart: unless-stopped
    ports:
      - "5000:5000"
      - "9091:9091"
    environment:
      - NODE_ENV=production
      - PORT=5000
      - DB_PATH=/app/storage/db/fhirhub.db
      - DB_PERSISTENT=true
      - JWT_SECRET=fhirhub-secure-jwt-secret
      - METRICS_ENABLED=true
      - METRICS_PORT=9091
    volumes:
      # Structure simplifiée des volumes
      - ./data/db:/app/storage/db:rw
      - ./data/app_data:/app/storage/data:rw
      - ./data/logs:/app/storage/logs:rw
      - ./data/backups:/app/storage/backups:rw
      - ./data/french_terminology:/app/french_terminology:rw
    user: "root"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - fhirhub-network
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"

# Définition des réseaux
networks:
  fhirhub-network:
    driver: bridge